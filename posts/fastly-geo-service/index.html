<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Fastly Geolocation Service | @abiydv</title>
<meta name=keywords content="fastly,vcl,terraform"><meta name=description content="Fastly service which returns information about a public IP"><meta name=author content><link rel=canonical href=https://abiydv.github.io/posts/fastly-geo-service/><link crossorigin=anonymous href=/assets/css/stylesheet.c5edd088d0c984c192170cfbab7d2de030010ee0b7d771bd6bca049dd2332874.css integrity="sha256-xe3QiNDJhMGSFwz7q30t4DABDuC313G9a8oEndIzKHQ=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://abiydv.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://abiydv.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://abiydv.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://abiydv.github.io/apple-touch-icon.png><link rel=mask-icon href=https://abiydv.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://abiydv.github.io/posts/fastly-geo-service/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Fastly Geolocation Service"><meta property="og:description" content="Fastly service which returns information about a public IP"><meta property="og:type" content="article"><meta property="og:url" content="https://abiydv.github.io/posts/fastly-geo-service/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-03-06T00:00:00+00:00"><meta property="article:modified_time" content="2021-03-06T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Fastly Geolocation Service"><meta name=twitter:description content="Fastly service which returns information about a public IP"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://abiydv.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Fastly Geolocation Service","item":"https://abiydv.github.io/posts/fastly-geo-service/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Fastly Geolocation Service","name":"Fastly Geolocation Service","description":"Fastly service which returns information about a public IP","keywords":["fastly","vcl","terraform"],"articleBody":"Introduction Fastly is a popular CDN based on the open-source Varnish. Since it supports VCL, a lot of custom “logic” to handle incoming requests can be added, right at the edge. It also provides a host of geolocation identification options.\nIn this post, we’ll build on the service we created in a previous post Fastly Meta Service to implement a simple API which returns details about a particular public IP.\nThis service can be nice value add, whether for use by machines (json output helps!) or by non-technical folks to gather useful info tech teams often need to solve/debug “Does not work from my home. I get an error, please fix!” issues.\nSolution The service will rely entirely on Fastly’s infrastructure and will not interact with the configured origin at all! Sadly, you cannot launch a service without any origin at this point, so you would need to add some dummy host. httpbin.org maybe a good choice here!\nSuch an isolated request flow is possible, thanks to the synthetic responses that can be served directly from Fastly using the vcl constructs.\nThe request flow will look like this (no requests are sent to the origin) - Geolocation Database Fastly uses 2 vendors to fetch the geolocation details - Maxmind and Digital Element. This Fastly docs page lists out the different variables that are available for use. Broadly these variables are available under 2 distinct namespaces, each provided by a different vendor. client.geo.* namespace variables are provided by Digital Element, while geoip.* namespace variables are provided by Maxmind.\nNote that Fastly has deprecated Maxmind, so any future implementations should only be using the client.geo.* variables as outlined in this post.\nAPI Endpoints We will build the following endpoints\nRequest\nGET / Response\n1{ 2 \"date\": \"Timestamp in GMT\", 3 \"ipv6\": \"true|false\", 4 \"public_ip\": \"public ip\", 5 \"de_city\": \"city from DE database\", 6 \"de_country\": \"country from DE database\", 7 \"de_continent\": \"continent from DE database\", 8 \"de_proxy\" : \"proxy type and description from DE database\", 9 \"mx_city\": \"city from Maxmind database\", 10 \"mx_country\": \"city from Maxmind database\", 11 \"mx_continent\": \"countinent from Maxmind database\" 12} Request\nGET /?ip=ip_v4_add or ip_v6_add Response\n1{ 2 \"date\": \"Timestamp in GMT\", 3 \"ipv6\": \"true|false\", 4 \"public_ip\": \"provided ip_v4_add or ip_v6_add\", 5 \"de_city\": \"city from DE database\", 6 \"de_country\": \"country from DE database\", 7 \"de_continent\": \"continent from DE database\", 8 \"de_proxy\" : \"proxy type and description from DE database\", 9 \"mx_city\": \"city from Maxmind database\", 10 \"mx_country\": \"city from Maxmind database\", 11 \"mx_continent\": \"countinent from Maxmind database\" 12} Request\nGET /random Response\n301 Redirect to / VCL Snippets We will modify the vcl snippets recv and error created previously to extend the service and provide more details.\nUpdate the recv snippet with this code -\n1if (!req.url.path ~ \"^/$\" || !req.http.Fastly-SSL){ 2 error 618; 3} 4 5set req.url = querystring.filter_except(req.url, \"ip\"); 6 7if (fastly.ff.visits_this_service == 0 \u0026\u0026 req.restarts == 0) { 8 set req.http.Fastly-Client-IP = client.ip; 9 set req.http.ipv6 = \"false\"; 10 if (req.is_ipv6){ 11 set req.http.ipv6 = \"true\"; 12 } 13} 14 15if (req.url.qs ~ \"ip\"){ 16 set req.http.Fastly-Client-IP = querystring.get(req.url, \"ip\"); 17 set client.geo.ip_override = req.http.Fastly-Client-IP; 18 set geoip.ip_override = req.http.Fastly-Client-IP; 19} 20 21error 620; Update the error snippet with this code -\n1if (obj.status == 618) { 2 set obj.status = 301; 3 set obj.response = \"Moved Permanently\"; 4 set obj.http.Location = \"https://\" req.http.host \"/\"; 5 set obj.http.cache-control = \"private, no-store, no-cache, max-age=0\"; 6 return (deliver); 7} 8 9if (obj.status == 620) { 10 set obj.status = 200; 11 set obj.response = \"OK\"; 12 set obj.http.Content-Type = \"application/json\"; 13 set obj.http.cache-control = \"private, no-store, no-cache, max-age=0\"; 14 synthetic 15{\"{ 16 \"date\": \"\"} now {\"\", 17 \"ipv6\": \"\"} req.http.ipv6 {\"\", 18 \"public_ip\": \"\"} req.http.Fastly-Client-IP {\"\", 19 \"de_city\": \"\"} client.geo.city {\"\", 20 \"de_country\": \"\"} client.geo.country_code {\"\", 21 \"de_continent\": \"\"} client.geo.continent_code {\"\", 22 \"de_proxy\" : \"\"} client.geo.proxy_type \" - \" client.geo.proxy_description {\"\", 23 \"mx_city\": \"\"} geoip.city {\"\", 24 \"mx_country\": \"\"} geoip.country_code {\"\", 25 \"mx_continent\": \"\"} geoip.continent_code {\"\" 26}\"}; 27 return (deliver); 28} You can see/test this flow in a fiddle here\nSnippets also committed to the repo\nDeployment The service, configurations and vcls can be deployed to Fastly using Terraform. The required Terraform code is similar to what we used in the last post and is available here\nOutputs Once the service is ready, a simple request via curl or browser will return the details like below. I am using the test domain, hence need to use the -k flag (for more uses of curl, you can check this post). For a production level deployment, you would obviously map a custom domain to the service and also use SSL (Fastly provided or self procured).\nLet’s check a few curl responses.\nProton Public IP If you are connected to the ProtonVPN free NL server, this is what you should see. Note the difference of output between the Maxmind and DE outputs. Maxmind says it’s a US IP!\n1$ curl -k https://meta.dane-example.com.global.prod.fastly.net/ 2 3{ 4 \"date\": \"Fri, 05 Mar 2021 16:23:53 GMT\", 5 \"ipv6\": \"false\", 6 \"public_ip\": \"34.66.60.237\", 7 \"de_city\": \"HUISSEN\", 8 \"de_country\": \"NL\", 9 \"de_continent\": \"EU\", 10 \"de_proxy\" : \"HOSTING - VPN\", 11 \"mx_city\": \"COUNCIL BLUFFS\", 12 \"mx_country\": \"US\", 13 \"mx_continent\": \"NA\" 14} Google Public IP Let’s inspect a public IP, maybe the Google DNS? This time both vendors show the correct country, but Maxmind is off the mark on city.\n1$ curl -k https://meta.dane-example.com.global.prod.fastly.net/?ip=8.8.8.8 2 3{ 4 \"date\": \"Fri, 05 Mar 2021 16:23:53 GMT\", 5 \"ipv6\": \"false\", 6 \"public_ip\": \"8.8.8.8\", 7 \"de_city\": \"MOUNTAIN VIEW\", 8 \"de_country\": \"US\", 9 \"de_continent\": \"NA\", 10 \"de_proxy\" : \"ANONYMOUS - ?\", 11 \"mx_city\": \"NEW YORK\", 12 \"mx_country\": \"US\", 13 \"mx_continent\": \"NA\" 14} Public IPv6 Let’s try the IPv6 address now, if that works? Google DNS again. Maxmind doesn’t have any details about IPv6, DE does.\n1$ curl -k https://meta.dane-example.com.global.prod.fastly.net/?ip=2001:4860:4860::8888 2 3{ 4 \"date\": \"Fri, 05 Mar 2021 16:23:53 GMT\", 5 \"ipv6\": \"false\", 6 \"public_ip\": \"2001:4860:4860::8888\", 7 \"de_city\": \"MOUNTAIN VIEW\", 8 \"de_country\": \"US\", 9 \"de_continent\": \"NA\", 10 \"de_proxy\" : \"? - ?\", 11 \"mx_city\": \"\", 12 \"mx_country\": \"\", 13 \"mx_continent\": \"\" 14} Private IP What will it return for a private IP? Maxmind is trumped again, however, DE does tell you it’s a private IP. Nice.\n1$ curl -k https://meta.dane-example.com.global.prod.fastly.net/?ip=192.168.1.1 2 3{ 4 \"date\": \"Fri, 05 Mar 2021 16:23:53 GMT\", 5 \"ipv6\": \"false\", 6 \"public_ip\": \"192.168.1.1\", 7 \"de_city\": \"PRIVATE\", 8 \"de_country\": \"**\", 9 \"de_continent\": \"**\", 10 \"de_proxy\" : \"? - ?\", 11 \"mx_city\": \"\", 12 \"mx_country\": \"\", 13 \"mx_continent\": \"\" 14} What if someone hits a random path?\nSince the body doesn’t return anything for redirects, we will either have to follow redirect using -L or inspect the headers to confirm the response.\nLet’s do the latter.\n1$ curl -k -I https://meta.dane-example.com.global.prod.fastly.net/random 2 3HTTP/2 301 Moved Permanently 4accept-ranges: bytes 5cache-control: private, no-store, no-cache, max-age=0 6content-length: 0 7date: Fri, 05 Mar 2021 16:23:53 GMT 8location: https://meta.dane-example.com.global.prod.fastly.net/ 9retry-after: 0 Conclusion We enhanced the previous basic version considerably, by returning output from both vendors as well as making the response more machine friendly. It is possible to further enhance this service to put out even more information, as needed. It removes any reliance on 3rd party services which may or may not be hosted in secure environments.\nThe simpler service with only txt output is desribed in a previous post - Fastly Meta Service.\nNote: Code mentioned above is here References (1) Geolocation ","wordCount":"1225","inLanguage":"en","datePublished":"2021-03-06T00:00:00Z","dateModified":"2021-03-06T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://abiydv.github.io/posts/fastly-geo-service/"},"publisher":{"@type":"Organization","name":"@abiydv","logo":{"@type":"ImageObject","url":"https://abiydv.github.io/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://abiydv.github.io/ accesskey=h title="@abiydv (Alt + H)">@abiydv</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://abiydv.github.io/ title=Home><span>Home</span></a></li><li><a href=https://abiydv.github.io/about/ title=About><span>About</span></a></li><li><a href=https://abiydv.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://abiydv.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://abiydv.github.io/notes/ title=Notes><span>Notes</span></a></li><li><a href=https://abiydv.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://abiydv.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://abiydv.github.io/posts/>Posts</a></div><h1 class=post-title>Fastly Geolocation Service</h1><div class=post-description>Fastly service which returns information about a public IP</div><div class=post-meta>6.3.21 / Posts / 6 min</div></header><div class=post-content><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p><a href=https://www.fastly.com/why-fastly>Fastly</a> is a popular CDN based on the open-source <a href=https://varnish-cache.org/intro/index.html#intro>Varnish</a>. Since it supports <a href=https://varnish-cache.org/docs/2.1/reference/vcl.html>VCL</a>, a lot of custom &ldquo;logic&rdquo; to handle incoming requests can be added, right at the edge. It also provides a host of geolocation identification options.</p><p>In this post, we&rsquo;ll build on the service we created in a previous post <a href=/posts/fastly-meta-service/>Fastly Meta Service</a> to implement a simple API which returns details about a particular public IP.</p><p>This service can be nice value add, whether for use by machines (json output helps!) or by non-technical folks to gather useful info tech teams often need to solve/debug &ldquo;<em>Does not work from my home. I get an error, please fix!</em>&rdquo; issues.</p><h2 id=solution>Solution<a hidden class=anchor aria-hidden=true href=#solution>#</a></h2><p>The service will rely entirely on Fastly&rsquo;s infrastructure and will not interact with the configured origin at all! Sadly, you cannot launch a service without any origin at this point, so you would need to add some dummy host. <a href=https://httpbin.org/>httpbin.org</a> maybe a good choice here!</p><p>Such an isolated request flow is possible, thanks to the synthetic responses that can be served directly from Fastly using the vcl constructs.</p><p>The request flow will look like this (no requests are sent to the origin) -
<img loading=lazy src=../../images/fastly-geo-service.jpg alt=fastly-geo-service></p><h2 id=geolocation-database>Geolocation Database<a hidden class=anchor aria-hidden=true href=#geolocation-database>#</a></h2><p>Fastly uses 2 vendors to fetch the geolocation details - <a href=https://www.maxmind.com/>Maxmind</a> and <a href=https://www.digitalelement.com/>Digital Element</a>. This Fastly docs <a href=https://developer.fastly.com/reference/vcl/variables/geolocation/>page</a> lists out the different variables that are available for use. Broadly these variables are available under 2 distinct namespaces, each provided by a different vendor. <code>client.geo.*</code> namespace variables are provided by Digital Element, while <code>geoip.*</code> namespace variables are provided by Maxmind.</p><p>Note that Fastly has deprecated Maxmind, so any future implementations should only be using the <code>client.geo.*</code> variables as outlined in this <a href=https://docs.fastly.com/en/guides/migrating-geolocation-variables-to-the-new-dataset>post</a>.</p><h2 id=api-endpoints>API Endpoints<a hidden class=anchor aria-hidden=true href=#api-endpoints>#</a></h2><p>We will build the following endpoints</p><p><strong>Request</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>GET /
</span></span></span></code></pre></div><p><strong>Response</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#f92672>&#34;date&#34;</span>: <span style=color:#e6db74>&#34;Timestamp in GMT&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#f92672>&#34;ipv6&#34;</span>: <span style=color:#e6db74>&#34;true|false&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#f92672>&#34;public_ip&#34;</span>: <span style=color:#e6db74>&#34;public ip&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#f92672>&#34;de_city&#34;</span>: <span style=color:#e6db74>&#34;city from DE database&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#f92672>&#34;de_country&#34;</span>: <span style=color:#e6db74>&#34;country from DE database&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#f92672>&#34;de_continent&#34;</span>: <span style=color:#e6db74>&#34;continent from DE database&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#f92672>&#34;de_proxy&#34;</span> : <span style=color:#e6db74>&#34;proxy type and description from DE database&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#f92672>&#34;mx_city&#34;</span>: <span style=color:#e6db74>&#34;city from Maxmind database&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#f92672>&#34;mx_country&#34;</span>: <span style=color:#e6db74>&#34;city from Maxmind database&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#f92672>&#34;mx_continent&#34;</span>: <span style=color:#e6db74>&#34;countinent from Maxmind database&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>}
</span></span></code></pre></div><p><strong>Request</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>GET /?ip=ip_v4_add or ip_v6_add
</span></span></span></code></pre></div><p><strong>Response</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#f92672>&#34;date&#34;</span>: <span style=color:#e6db74>&#34;Timestamp in GMT&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#f92672>&#34;ipv6&#34;</span>: <span style=color:#e6db74>&#34;true|false&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#f92672>&#34;public_ip&#34;</span>: <span style=color:#e6db74>&#34;provided ip_v4_add or ip_v6_add&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#f92672>&#34;de_city&#34;</span>: <span style=color:#e6db74>&#34;city from DE database&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#f92672>&#34;de_country&#34;</span>: <span style=color:#e6db74>&#34;country from DE database&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#f92672>&#34;de_continent&#34;</span>: <span style=color:#e6db74>&#34;continent from DE database&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#f92672>&#34;de_proxy&#34;</span> : <span style=color:#e6db74>&#34;proxy type and description from DE database&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#f92672>&#34;mx_city&#34;</span>: <span style=color:#e6db74>&#34;city from Maxmind database&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#f92672>&#34;mx_country&#34;</span>: <span style=color:#e6db74>&#34;city from Maxmind database&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#f92672>&#34;mx_continent&#34;</span>: <span style=color:#e6db74>&#34;countinent from Maxmind database&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>}
</span></span></code></pre></div><p><strong>Request</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>GET /random
</span></span></span></code></pre></div><p><strong>Response</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#ae81ff>301</span> Redirect to /
</span></span></code></pre></div><h2 id=vcl-snippets>VCL Snippets<a hidden class=anchor aria-hidden=true href=#vcl-snippets>#</a></h2><p>We will modify the vcl snippets <code>recv</code> and <code>error</code> created previously to extend the service and provide more details.</p><p>Update the <code>recv</code> snippet with this code -</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>!req.url.path ~ <span style=color:#e6db74>&#34;^/</span>$<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>||</span> !req.http.Fastly-SSL<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  error 618;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>set req.url <span style=color:#f92672>=</span> querystring.filter_except<span style=color:#f92672>(</span>req.url, <span style=color:#e6db74>&#34;ip&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>fastly.ff.visits_this_service <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> req.restarts <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>  set req.http.Fastly-Client-IP <span style=color:#f92672>=</span> client.ip;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  set req.http.ipv6 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;false&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>req.is_ipv6<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    set req.http.ipv6 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;true&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>req.url.qs ~ <span style=color:#e6db74>&#34;ip&#34;</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>  set req.http.Fastly-Client-IP <span style=color:#f92672>=</span> querystring.get<span style=color:#f92672>(</span>req.url, <span style=color:#e6db74>&#34;ip&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>  set client.geo.ip_override <span style=color:#f92672>=</span> req.http.Fastly-Client-IP;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>  set geoip.ip_override <span style=color:#f92672>=</span> req.http.Fastly-Client-IP;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>error 620;
</span></span></code></pre></div><p>Update the <code>error</code> snippet with this code -</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>obj.status <span style=color:#f92672>==</span> 618<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    set obj.status <span style=color:#f92672>=</span> 301;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    set obj.response <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Moved Permanently&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    set obj.http.Location <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://&#34;</span> req.http.host <span style=color:#e6db74>&#34;/&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    set obj.http.cache-control <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;private, no-store, no-cache, max-age=0&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>deliver<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>obj.status <span style=color:#f92672>==</span> 620<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    set obj.status <span style=color:#f92672>=</span> 200;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    set obj.response <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;OK&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    set obj.http.Content-Type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;application/json&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    set obj.http.cache-control <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;private, no-store, no-cache, max-age=0&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    synthetic 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;{
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#e6db74>    &#34;</span>date<span style=color:#e6db74>&#34;: &#34;&#34;} now {&#34;&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#e6db74>    &#34;</span>ipv6<span style=color:#e6db74>&#34;: &#34;&#34;} req.http.ipv6 {&#34;&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#e6db74>    &#34;</span>public_ip<span style=color:#e6db74>&#34;: &#34;&#34;} req.http.Fastly-Client-IP {&#34;&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#e6db74>    &#34;</span>de_city<span style=color:#e6db74>&#34;: &#34;&#34;} client.geo.city {&#34;&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#e6db74>    &#34;</span>de_country<span style=color:#e6db74>&#34;: &#34;&#34;} client.geo.country_code {&#34;&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#e6db74>    &#34;</span>de_continent<span style=color:#e6db74>&#34;: &#34;&#34;} client.geo.continent_code {&#34;&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#e6db74>    &#34;</span>de_proxy<span style=color:#e6db74>&#34; : &#34;&#34;} client.geo.proxy_type  &#34;</span> - <span style=color:#e6db74>&#34; client.geo.proxy_description {&#34;&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#e6db74>    &#34;</span>mx_city<span style=color:#e6db74>&#34;: &#34;&#34;} geoip.city {&#34;&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#e6db74>    &#34;</span>mx_country<span style=color:#e6db74>&#34;: &#34;&#34;} geoip.country_code {&#34;&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#e6db74>    &#34;</span>mx_continent<span style=color:#e6db74>&#34;: &#34;&#34;} geoip.continent_code {&#34;&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#e6db74>}&#34;</span><span style=color:#f92672>}</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>deliver<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>You can see/test this flow in a fiddle <a href=https://fiddle.fastlydemo.net/fiddle/71c0ee7b>here</a></p><p>Snippets also committed to the <a href=https://github.com/abiydv/fastly-meta-service/tree/geo-service>repo</a></p><h2 id=deployment>Deployment<a hidden class=anchor aria-hidden=true href=#deployment>#</a></h2><p>The service, configurations and vcls can be deployed to Fastly using Terraform. The required Terraform code is similar to what we used in the last post and is available <a href=https://github.com/abiydv/fastly-meta-service/tree/geo-service>here</a></p><h2 id=outputs>Outputs<a hidden class=anchor aria-hidden=true href=#outputs>#</a></h2><p>Once the service is ready, a simple request via <code>curl</code> or browser will return the details like below. I am using the test domain, hence need to use the <code>-k</code> flag (for more uses of <code>curl</code>, you can check this <a href=/posts/curl-cheatsheet/>post</a>). For a production level deployment, you would obviously map a custom domain to the service and also use SSL (Fastly provided or self procured).</p><p>Let&rsquo;s check a few curl responses.</p><h3 id=proton-public-ip>Proton Public IP<a hidden class=anchor aria-hidden=true href=#proton-public-ip>#</a></h3><p>If you are connected to the <a href=https://protonvpn.com/>ProtonVPN</a> free NL server, this is what you should see. Note the difference of output between the Maxmind and DE outputs. Maxmind says it&rsquo;s a US IP!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>$ curl -k https://meta.dane-example.com.global.prod.fastly.net/
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#e6db74>&#34;date&#34;</span>: <span style=color:#e6db74>&#34;Fri, 05 Mar 2021 16:23:53 GMT&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#e6db74>&#34;ipv6&#34;</span>: <span style=color:#e6db74>&#34;false&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#e6db74>&#34;public_ip&#34;</span>: <span style=color:#e6db74>&#34;34.66.60.237&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#e6db74>&#34;de_city&#34;</span>: <span style=color:#e6db74>&#34;HUISSEN&#34;</span>,
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#e6db74>&#34;de_country&#34;</span>: <span style=color:#e6db74>&#34;NL&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#e6db74>&#34;de_continent&#34;</span>: <span style=color:#e6db74>&#34;EU&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#e6db74>&#34;de_proxy&#34;</span> : <span style=color:#e6db74>&#34;HOSTING - VPN&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#e6db74>&#34;mx_city&#34;</span>: <span style=color:#e6db74>&#34;COUNCIL BLUFFS&#34;</span>,
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#e6db74>&#34;mx_country&#34;</span>: <span style=color:#e6db74>&#34;US&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#e6db74>&#34;mx_continent&#34;</span>: <span style=color:#e6db74>&#34;NA&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=google-public-ip>Google Public IP<a hidden class=anchor aria-hidden=true href=#google-public-ip>#</a></h3><p>Let&rsquo;s inspect a public IP, maybe the Google DNS? This time both vendors show the correct country, but Maxmind is off the mark on city.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>$ curl -k https://meta.dane-example.com.global.prod.fastly.net/?ip<span style=color:#f92672>=</span>8.8.8.8 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#e6db74>&#34;date&#34;</span>: <span style=color:#e6db74>&#34;Fri, 05 Mar 2021 16:23:53 GMT&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#e6db74>&#34;ipv6&#34;</span>: <span style=color:#e6db74>&#34;false&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#e6db74>&#34;public_ip&#34;</span>: <span style=color:#e6db74>&#34;8.8.8.8&#34;</span>,
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#e6db74>&#34;de_city&#34;</span>: <span style=color:#e6db74>&#34;MOUNTAIN VIEW&#34;</span>,
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#e6db74>&#34;de_country&#34;</span>: <span style=color:#e6db74>&#34;US&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#e6db74>&#34;de_continent&#34;</span>: <span style=color:#e6db74>&#34;NA&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#e6db74>&#34;de_proxy&#34;</span> : <span style=color:#e6db74>&#34;ANONYMOUS - ?&#34;</span>,
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#e6db74>&#34;mx_city&#34;</span>: <span style=color:#e6db74>&#34;NEW YORK&#34;</span>,
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#e6db74>&#34;mx_country&#34;</span>: <span style=color:#e6db74>&#34;US&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#e6db74>&#34;mx_continent&#34;</span>: <span style=color:#e6db74>&#34;NA&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=public-ipv6>Public IPv6<a hidden class=anchor aria-hidden=true href=#public-ipv6>#</a></h3><p>Let&rsquo;s try the IPv6 address now, if that works? Google DNS again. Maxmind doesn&rsquo;t have any details about IPv6, DE does.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>$ curl -k https://meta.dane-example.com.global.prod.fastly.net/?ip<span style=color:#f92672>=</span>2001:4860:4860::8888
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#e6db74>&#34;date&#34;</span>: <span style=color:#e6db74>&#34;Fri, 05 Mar 2021 16:23:53 GMT&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#e6db74>&#34;ipv6&#34;</span>: <span style=color:#e6db74>&#34;false&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#e6db74>&#34;public_ip&#34;</span>: <span style=color:#e6db74>&#34;2001:4860:4860::8888&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#e6db74>&#34;de_city&#34;</span>: <span style=color:#e6db74>&#34;MOUNTAIN VIEW&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#e6db74>&#34;de_country&#34;</span>: <span style=color:#e6db74>&#34;US&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#e6db74>&#34;de_continent&#34;</span>: <span style=color:#e6db74>&#34;NA&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#e6db74>&#34;de_proxy&#34;</span> : <span style=color:#e6db74>&#34;? - ?&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#e6db74>&#34;mx_city&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#e6db74>&#34;mx_country&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#e6db74>&#34;mx_continent&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=private-ip>Private IP<a hidden class=anchor aria-hidden=true href=#private-ip>#</a></h3><p>What will it return for a private IP? Maxmind is trumped again, however, DE does tell you it&rsquo;s a private IP. Nice.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>$ curl -k https://meta.dane-example.com.global.prod.fastly.net/?ip<span style=color:#f92672>=</span>192.168.1.1
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#e6db74>&#34;date&#34;</span>: <span style=color:#e6db74>&#34;Fri, 05 Mar 2021 16:23:53 GMT&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#e6db74>&#34;ipv6&#34;</span>: <span style=color:#e6db74>&#34;false&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#e6db74>&#34;public_ip&#34;</span>: <span style=color:#e6db74>&#34;192.168.1.1&#34;</span>,
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#e6db74>&#34;de_city&#34;</span>: <span style=color:#e6db74>&#34;PRIVATE&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#e6db74>&#34;de_country&#34;</span>: <span style=color:#e6db74>&#34;**&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#e6db74>&#34;de_continent&#34;</span>: <span style=color:#e6db74>&#34;**&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#e6db74>&#34;de_proxy&#34;</span> : <span style=color:#e6db74>&#34;? - ?&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#e6db74>&#34;mx_city&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#e6db74>&#34;mx_country&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#e6db74>&#34;mx_continent&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>What if someone hits a random path?</p><p>Since the body doesn&rsquo;t return anything for redirects, we will either have to follow redirect using <code>-L</code> or inspect the headers to confirm the response.</p><p>Let&rsquo;s do the latter.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ curl -k -I https://meta.dane-example.com.global.prod.fastly.net/random
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>HTTP/2 <span style=color:#ae81ff>301</span> Moved Permanently
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>accept-ranges: bytes
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>cache-control: private, no-store, no-cache, max-age<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>content-length: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>date: Fri, <span style=color:#ae81ff>05</span> Mar <span style=color:#ae81ff>2021</span> 16:23:53 GMT
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>location: https://meta.dane-example.com.global.prod.fastly.net/
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>retry-after: <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>We enhanced the previous basic version considerably, by returning output from both vendors as well as making the response more machine friendly. It is possible to further enhance this service to put out even more information, as needed. It removes any reliance on 3rd party services which may or may not be hosted in secure environments.</p><p>The simpler service with only txt output is desribed in a previous post - <a href=/posts/fastly-meta-service/>Fastly Meta Service</a>.</p><b>Note:</b>&nbsp;
Code mentioned above is
<a aria-label="link to https://github.com/abiydv/fastly-meta-service" target=_blank href=https://github.com/abiydv/fastly-meta-service>here&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg><h2>References (1)</h2><ol class=slimlist-ol><li class=slimlist-ol><a aria-label="link to https://developer.fastly.com/reference/vcl/variables/geolocation" target=_blank href=https://developer.fastly.com/reference/vcl/variables/geolocation>Geolocation&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ol></div><footer class=post-footer><hr><div class=align-center><div class=slimlist-entry><h2>Tags</h2></div><ul class=post-tags><div class=slimlist-entry><li class=post-tags><a href=https://abiydv.github.io/tags/fastly/>fastly</a></li><li class=post-tags><a href=https://abiydv.github.io/tags/vcl/>vcl</a></li><li class=post-tags><a href=https://abiydv.github.io/tags/terraform/>terraform</a></li></div></ul></div></footer><script src=https://utteranc.es/client.js repo=abiydv/abiydv.github.io issue-term=title label=Comment theme=github-light crossorigin=anonymous async></script><hr><div class=align-left><div class=slimlist-entry><h2>Related</h2></div><ul class=slimlist><li class=slimlist><div class=slimlist-entry><h3 class=slimlist-entry-title><a aria-label="post link to Fastly Meta Service" href=https://abiydv.github.io/posts/fastly-meta-service/>Fastly Meta Service</a></h3><div class=slimlist-meta>10.11.20 / Posts / 3 min</div></div></li><li class=slimlist><div class=slimlist-entry><h3 class=slimlist-entry-title><a aria-label="post link to Terraform, Bitbucket pipelines and OIDC" href=https://abiydv.github.io/posts/terraform-bitbucket-pipeline-oidc/>Terraform, Bitbucket pipelines and OIDC</a></h3><div class=slimlist-meta>30.9.21 / Posts / 7 min</div></div></li><li class=slimlist><div class=slimlist-entry><h3 class=slimlist-entry-title><a aria-label="post link to Terraform, multi-account and multi-region workloads" href=https://abiydv.github.io/posts/terraform-multiaccount-multiregion/>Terraform, multi-account and multi-region workloads</a></h3><div class=slimlist-meta>25.5.22 / Posts / 5 min</div></div></li></ul></div></article></main><footer class=footer><span>&copy; 2019-2025 <a href=https://abiydv.github.io/>@abiydv</a> / </span><span>Published 4.4.25 /
</span><span>Thanks <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a>, <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>