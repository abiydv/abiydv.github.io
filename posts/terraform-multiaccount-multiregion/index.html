<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Terraform, multi-account and multi-region workloads | @abiydv</title>
<meta name=keywords content="terraform,aws,cicd,cli"><meta name=description content="Managing multi-account, multi-region workloads using Terraform"><meta name=author content><link rel=canonical href=https://abiydv.github.io/posts/terraform-multiaccount-multiregion/><link crossorigin=anonymous href=/assets/css/stylesheet.c5edd088d0c984c192170cfbab7d2de030010ee0b7d771bd6bca049dd2332874.css integrity="sha256-xe3QiNDJhMGSFwz7q30t4DABDuC313G9a8oEndIzKHQ=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://abiydv.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://abiydv.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://abiydv.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://abiydv.github.io/apple-touch-icon.png><link rel=mask-icon href=https://abiydv.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://abiydv.github.io/posts/terraform-multiaccount-multiregion/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Terraform, multi-account and multi-region workloads"><meta property="og:description" content="Managing multi-account, multi-region workloads using Terraform"><meta property="og:type" content="article"><meta property="og:url" content="https://abiydv.github.io/posts/terraform-multiaccount-multiregion/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-25T00:00:00+00:00"><meta property="article:modified_time" content="2022-05-25T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Terraform, multi-account and multi-region workloads"><meta name=twitter:description content="Managing multi-account, multi-region workloads using Terraform"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://abiydv.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Terraform, multi-account and multi-region workloads","item":"https://abiydv.github.io/posts/terraform-multiaccount-multiregion/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Terraform, multi-account and multi-region workloads","name":"Terraform, multi-account and multi-region workloads","description":"Managing multi-account, multi-region workloads using Terraform","keywords":["terraform","aws","cicd","cli"],"articleBody":"Introduction Terraform is one of the most popular IAC tools out there. Although, it is quite simple to grasp and use, the complexity rises quickly once you introduce multi-account and multi-region deployments.\nThis post is inspired by one such problem I had to tackle recently.\nProblem How to create and manage multi-account and multi-region AWS resources using Terraform?\nA lot of organizations now seggregate their AWS accounts on the basis of environments (development, test, production etc.). At the same time, due to DR considerations, the production workloads also need to span across regions. This results in a multi-dimensional array of combinations between accounts and regions.\nTo top it all, the cicd tool (most often) runs in a separate dedicated account (say, operator).\nSolution Terraform workspaces to the rescue! Well, almost.\nTerraform workspaces have been available for quite sometime now, and don’t need much of an introduction. A small clarification here is in order though. When I mention workspaces, I am referring to the cli workspace and NOT the Terraform cloud workspace.\nWorkspaces make it fairly easy to deploy the same configuration over and over again by simply overriding the variable values. This keeps the configurations minimal, but, at the same time provides enough flexibility to create multiple environments that are isolated from each other.\nIn this particular case, I use the same names for the workspaces as the environments - development and production. The benefit of this will become clear when you look at the configurations and cicd commands.\nAs you already know, to target different AWS accounts and regions, the provider block is what we need to focus on. This is the configuration which dictates which account and region Terraform runs the API commands against.\nSince Terraform does not support dynamic provider blocks (yet!), it is clear a bunch of explicit provider blocks are necessary to interact with different accounts and regions.\nSome optimization is still possible though since the provider block does support specifying variables. Following is an example providers.tf file which enables working with multiple accounts and regions. Explanation follows after this snippet.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 provider \"aws\" { region = \"eu-west-1\" } provider \"aws\" { region = \"eu-west-1\" alias = \"euw1\" assume_role { role_arn = var.role_arn[terraform.workspace] } } provider \"aws\" { region = \"us-west-1\" alias = \"usw1\" assume_role { role_arn = var.role_arn[terraform.workspace] } } The first provider block is the default one, and is configured partially. AWS credentials are provided for it via environment variables. This is the provider which allows Terraform to use an S3 bucket, and Dynamodb table in the cicd tool account (operator) for state files and locking respectively.\nNext, 2 additional provider blocks are configured, each pointing to a specific region. Notice the alias being set for these providers, as this is necessary to use them later on in the configuration. Also note that the role_arn is not specified in these, rather it is being derived from a variable role_arn of type map(string). This variable is essentially where the magic happens. Depending on the current workspace, it provides the role_arn to Terraform from either the development account or production account. This can be easily extended to include more accounts and workspaces.\nLooking at the auto loading tfvars file below, should make it clearer. Note that these roles are pre-existing, and created as part of the cicd setup.\n1 2 3 4 role_arn = { development = \"arn:aws:iam::123456789012:role/TFRole\" production = \"arn:aws:iam::123456789013:role/TFRole\" } With the above configs, we are now ready to create and manage resources across AWS accounts and regions.\nBelow is a dummy file which can be quickly used to test (provided ofcourse, your target accounts/regions have a vpc named MyVPC) the configuration. The alias I mentioned above comes in handy here when declaring the data block. You can also use alias for resources and modules. More details here\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 variable \"role_arn\" { description = \"Map of role_arn to use in each account\" } data \"aws_vpc\" \"eu\" { provider = aws.euw1 filter { name = \"tag:Name\" values = [\"MyVPC\"] } } data \"aws_vpc\" \"us\" { provider = aws.usw1 filter { name = \"tag:Name\" values = [\"MyVPC\"] } } output \"eu\" { value = data.aws_vpc.eu.arn } output \"us\" { value = data.aws_vpc.us.arn } Finally, in the cicd pipeline, it’s very simple to target the specific environment using workspaces. The following few cli commands should do it. I only show this for the development environment, but I am sure, you get the drift!\n1 2 3 4 5 6 7 $ export WORKSPACE=development $ terraform select workspace $WORKSPACE || terraform new workspace $WORKSPACE # This commands loads an additional variable file named development.tfvars # Any environment specific customization can be put into this file $ terraform plan -input=false -var-file $WORKSPACE.tfvars $ terraform apply -input=false -auto-approve -var-file $WORKSPACE.tfvars The visualization of the above setup would probably look something like the diagram included at the begining of this post. Have a look at it now, it would probably make more sense.\nConclusion This is a simple pattern to manage resources with Terraform across AWS accounts and regions. It can be extended further to cater to environment specific customizations etc. This should atleast give you some ideas and help in getting started.\nIf you use a different simpler pattern, I would love to hear more about it. Please feel free to leave a link in the comments below.\nReferences (1) Configuration#alias Multiple Provider Configurations ","wordCount":"939","inLanguage":"en","datePublished":"2022-05-25T00:00:00Z","dateModified":"2022-05-25T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://abiydv.github.io/posts/terraform-multiaccount-multiregion/"},"publisher":{"@type":"Organization","name":"@abiydv","logo":{"@type":"ImageObject","url":"https://abiydv.github.io/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://abiydv.github.io/ accesskey=h title="@abiydv (Alt + H)">@abiydv</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://abiydv.github.io/ title=Home><span>Home</span></a></li><li><a href=https://abiydv.github.io/about/ title=About><span>About</span></a></li><li><a href=https://abiydv.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://abiydv.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://abiydv.github.io/notes/ title=Notes><span>Notes</span></a></li><li><a href=https://abiydv.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://abiydv.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://abiydv.github.io/posts/>Posts</a></div><h1 class=post-title>Terraform, multi-account and multi-region workloads</h1><div class=post-description>Managing multi-account, multi-region workloads using Terraform</div><div class=post-meta>25.5.22 / Posts / 5 min</div></header><div class=post-content><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p><a href=https://www.terraform.io/>Terraform</a> is one of the most popular IAC tools out there. Although, it is quite simple to grasp and use, the complexity rises quickly once you introduce multi-account and multi-region deployments.</p><p>This post is inspired by one such problem I had to tackle recently.</p><p><img loading=lazy src=../../images/terraform-workspace.png alt=terraform-workspace></p><h2 id=problem>Problem<a hidden class=anchor aria-hidden=true href=#problem>#</a></h2><p>How to create and manage multi-account and multi-region AWS resources using Terraform?</p><p>A lot of organizations now seggregate their AWS accounts on the basis of environments (<code>development</code>, <code>test</code>, <code>production</code> etc.). At the same time, due to DR considerations, the <code>production</code> workloads also need to span across regions. This results in a multi-dimensional array of combinations between accounts and regions.</p><p>To top it all, the cicd tool (most often) runs in a separate dedicated account (say, <code>operator</code>).</p><h2 id=solution>Solution<a hidden class=anchor aria-hidden=true href=#solution>#</a></h2><p>Terraform workspaces to the rescue! Well, almost.</p><p>Terraform workspaces have been available for quite sometime now, and don&rsquo;t need much of an introduction. A small clarification here is in order though. When I mention workspaces, I am referring to the <a href=https://www.terraform.io/language/state/workspaces>cli workspace</a> and NOT the Terraform <a href=https://www.terraform.io/cloud-docs/workspaces>cloud workspace</a>.</p><p>Workspaces make it fairly easy to deploy the same configuration over and over again by simply overriding the variable values. This keeps the configurations minimal, but, at the same time provides enough flexibility to create multiple environments that are isolated from each other.</p><p>In this particular case, I use the same names for the workspaces as the environments - <code>development</code> and <code>production</code>. The benefit of this will become clear when you look at the configurations and cicd commands.</p><p>As you already know, to target different AWS accounts and regions, the <code>provider</code> block is what we need to focus on. This is the configuration which dictates <em>which</em> account and region Terraform runs the API commands against.</p><p>Since Terraform does not support dynamic provider blocks (yet!), it is clear a bunch of explicit <code>provider</code> blocks are necessary to interact with different accounts and regions.</p><p><em>Some</em> optimization is still possible though since the <code>provider</code> block <em>does</em> support specifying variables. Following is an example <code>providers.tf</code> file which enables working with multiple accounts and regions. Explanation follows after this snippet.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tf data-lang=tf><span style=display:flex><span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;aws&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>region</span> = <span style=color:#e6db74>&#34;eu-west-1&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;aws&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>region</span> = <span style=color:#e6db74>&#34;eu-west-1&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>alias</span> = <span style=color:#e6db74>&#34;euw1&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>assume_role</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>role_arn</span> = var.<span style=color:#a6e22e>role_arn</span>[<span style=color:#a6e22e>terraform</span>.<span style=color:#a6e22e>workspace</span>]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;aws&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>region</span> = <span style=color:#e6db74>&#34;us-west-1&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>alias</span> = <span style=color:#e6db74>&#34;usw1&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>assume_role</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>role_arn</span> = var.<span style=color:#a6e22e>role_arn</span>[<span style=color:#a6e22e>terraform</span>.<span style=color:#a6e22e>workspace</span>]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>The first <code>provider</code> block is the default one, and is configured partially. AWS credentials are provided for it via environment variables. This is the <code>provider</code> which allows Terraform to use an S3 bucket, and Dynamodb table in the cicd tool account (<code>operator</code>) for state files and locking respectively.</p><p>Next, 2 additional <code>provider</code> blocks are configured, each pointing to a specific region. Notice the <code>alias</code> being set for these providers, as this is necessary to use them later on in the configuration. Also note that the <code>role_arn</code> is not specified in these, rather it is being derived from a variable <code>role_arn</code> of type <code>map(string)</code>. This variable is essentially where the <em>magic</em> happens. Depending on the current workspace, it provides the <code>role_arn</code> to Terraform from either the <code>development</code> account or <code>production</code> account. This can be easily extended to include more accounts and workspaces.</p><p>Looking at the auto loading <code>tfvars</code> file below, should make it clearer. Note that these roles are pre-existing, and created as part of the cicd setup.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tf data-lang=tf><span style=display:flex><span><span style=color:#a6e22e>role_arn</span> = {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>development</span> = <span style=color:#e6db74>&#34;arn:aws:iam::123456789012:role/TFRole&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>production</span>  = <span style=color:#e6db74>&#34;arn:aws:iam::123456789013:role/TFRole&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>With the above configs, we are now ready to create and manage resources across AWS accounts and regions.</p><p>Below is a dummy file which can be quickly used to test (provided ofcourse, your target accounts/regions have a vpc named <code>MyVPC</code>) the configuration. The <code>alias</code> I mentioned above comes in handy here when declaring the <code>data</code> block. You can also use <code>alias</code> for resources and modules. More details <a href=https://www.terraform.io/language/providers/configuration#alias-multiple-provider-configurations>here</a></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tf data-lang=tf><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;role_arn&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>description</span> = <span style=color:#e6db74>&#34;Map of role_arn to use in each account&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;aws_vpc&#34;</span> <span style=color:#e6db74>&#34;eu&#34;</span> {
</span></span><span style=display:flex><span><span style=color:#66d9ef>  provider</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>euw1</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>filter</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span>   = <span style=color:#e6db74>&#34;tag:Name&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>values</span> = [<span style=color:#e6db74>&#34;MyVPC&#34;</span>]
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;aws_vpc&#34;</span> <span style=color:#e6db74>&#34;us&#34;</span> {
</span></span><span style=display:flex><span><span style=color:#66d9ef>  provider</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>usw1</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>filter</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span>   = <span style=color:#e6db74>&#34;tag:Name&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>values</span> = [<span style=color:#e6db74>&#34;MyVPC&#34;</span>]
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;eu&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>value</span> = data.<span style=color:#a6e22e>aws_vpc</span>.<span style=color:#a6e22e>eu</span>.<span style=color:#a6e22e>arn</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;us&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>value</span> = data.<span style=color:#a6e22e>aws_vpc</span>.<span style=color:#a6e22e>us</span>.<span style=color:#a6e22e>arn</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>Finally, in the cicd pipeline, it&rsquo;s very simple to target the specific environment using workspaces. The following few cli commands should do it. I only show this for the <code>development</code> environment, but I am sure, you get the drift!</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ export WORKSPACE<span style=color:#f92672>=</span>development
</span></span><span style=display:flex><span>$ terraform <span style=color:#66d9ef>select</span> workspace $WORKSPACE  <span style=color:#f92672>||</span> terraform new workspace $WORKSPACE
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># This commands loads an additional variable file named development.tfvars</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Any environment specific customization can be put into this file</span>
</span></span><span style=display:flex><span>$ terraform plan -input<span style=color:#f92672>=</span>false -var-file $WORKSPACE.tfvars
</span></span><span style=display:flex><span>$ terraform apply -input<span style=color:#f92672>=</span>false -auto-approve -var-file $WORKSPACE.tfvars
</span></span></code></pre></td></tr></table></div></div><p>The visualization of the above setup would probably look something like the diagram included at the begining of this post. Have a look at it now, it would probably make more sense.</p><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>This is a simple pattern to manage resources with Terraform across AWS accounts and regions. It can be extended further to cater to environment specific customizations etc. This should atleast give you some ideas and help in getting started.</p><p>If you use a different simpler pattern, I would love to hear more about it. Please feel free to leave a link in the comments below.</p><h2>References (1)</h2><ol class=slimlist-ol><li class=slimlist-ol><a aria-label="link to https://www.terraform.io/language/providers/configuration#alias-multiple-provider-configurations" target=_blank href=https://www.terraform.io/language/providers/configuration#alias-multiple-provider-configurations>Configuration#alias Multiple Provider Configurations&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ol></div><footer class=post-footer><hr><div class=align-center><div class=slimlist-entry><h2>Tags</h2></div><ul class=post-tags><div class=slimlist-entry><li class=post-tags><a href=https://abiydv.github.io/tags/terraform/>terraform</a></li><li class=post-tags><a href=https://abiydv.github.io/tags/aws/>aws</a></li><li class=post-tags><a href=https://abiydv.github.io/tags/cicd/>cicd</a></li><li class=post-tags><a href=https://abiydv.github.io/tags/cli/>cli</a></li></div></ul></div></footer><script src=https://utteranc.es/client.js repo=abiydv/abiydv.github.io issue-term=title label=Comment theme=github-light crossorigin=anonymous async></script><hr><div class=align-left><div class=slimlist-entry><h2>Related</h2></div><ul class=slimlist><li class=slimlist><div class=slimlist-entry><h3 class=slimlist-entry-title><a aria-label="post link to Terraform, Bitbucket pipelines and OIDC" href=https://abiydv.github.io/posts/terraform-bitbucket-pipeline-oidc/>Terraform, Bitbucket pipelines and OIDC</a></h3><div class=slimlist-meta>30.9.21 / Posts / 7 min</div></div></li><li class=slimlist><div class=slimlist-entry><h3 class=slimlist-entry-title><a aria-label="post link to AWS CLI MFA Login" href=https://abiydv.github.io/posts/aws-cli-mfa-login/>AWS CLI MFA Login</a></h3><div class=slimlist-meta>9.8.20 / Posts / 3 min</div></div></li><li class=slimlist><div class=slimlist-entry><h3 class=slimlist-entry-title><a aria-label="post link to Service Control Policies and BDD" href=https://abiydv.github.io/posts/aws-scp-test-bdd/>Service Control Policies and BDD</a></h3><div class=slimlist-meta>28.6.24 / Posts / 7 min</div></div></li></ul></div></article></main><footer class=footer><span>&copy; 2019-2025 <a href=https://abiydv.github.io/>@abiydv</a> / </span><span>Published 4.4.25 /
</span><span>Thanks <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a>, <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>