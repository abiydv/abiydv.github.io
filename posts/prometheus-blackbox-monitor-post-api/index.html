<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Prometheus Blackbox Exporter and POST calls | @abiydv</title>
<meta name=keywords content="prometheus,blackbox,cncf,monitoring"><meta name=description content="Monitor API POST calls using Prometheus and Blackbox exporter"><meta name=author content><link rel=canonical href=https://abiydv.github.io/posts/prometheus-blackbox-monitor-post-api/><link crossorigin=anonymous href=/assets/css/stylesheet.c5edd088d0c984c192170cfbab7d2de030010ee0b7d771bd6bca049dd2332874.css integrity="sha256-xe3QiNDJhMGSFwz7q30t4DABDuC313G9a8oEndIzKHQ=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://abiydv.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://abiydv.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://abiydv.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://abiydv.github.io/apple-touch-icon.png><link rel=mask-icon href=https://abiydv.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://abiydv.github.io/posts/prometheus-blackbox-monitor-post-api/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Prometheus Blackbox Exporter and POST calls"><meta property="og:description" content="Monitor API POST calls using Prometheus and Blackbox exporter"><meta property="og:type" content="article"><meta property="og:url" content="https://abiydv.github.io/posts/prometheus-blackbox-monitor-post-api/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-09-28T00:00:00+00:00"><meta property="article:modified_time" content="2021-09-28T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Prometheus Blackbox Exporter and POST calls"><meta name=twitter:description content="Monitor API POST calls using Prometheus and Blackbox exporter"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://abiydv.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Prometheus Blackbox Exporter and POST calls","item":"https://abiydv.github.io/posts/prometheus-blackbox-monitor-post-api/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Prometheus Blackbox Exporter and POST calls","name":"Prometheus Blackbox Exporter and POST calls","description":"Monitor API POST calls using Prometheus and Blackbox exporter","keywords":["prometheus","blackbox","cncf","monitoring"],"articleBody":"Introduction Prometheus Blackbox Exporter is a popular plugin to test http endpoints. It offers a range of configuration options which can be tweaked to suit any use case. I recently had to implement monitoring for some APIs, each expecting a different content body.\nProblem By design, Prometheus blackbox exporter is not expected to work as a ‚Äúproxy‚Äù, so you cannot pass the body of a request via relabelling in Prometheus configs.\nLet‚Äôs say you want to monitor 2 APIs each of which expect you to provide a different payload. For this academic exercise, we can use https://httpbin.org/post as the API endpoint.\nSolution On a high level then, this needs 2 different steps -\nAdd a new module in blackbox exporter configs Add a new job in prometheus config to use the module created under 1. Step 1 - Blackbox Exporter The blackbox.yaml configuration file with 2 new modules for each post request. Notice we also use the property fail_if_body_not_matches_regexp, which will fail our test if the response doesn‚Äôt have the text we expect.\n1modules: 2 http_2xx: 3 prober: http 4 timeout: 5s 5 http: 6 valid_http_versions: [\"HTTP/1.1\", \"HTTP/2.0\"] 7 valid_status_codes: [] 8 method: GET 9 preferred_ip_protocol: \"ip4\" 10 ip_protocol_fallback: false 11 post_one_2xx: 12 prober: http 13 timeout: 5s 14 http: 15 valid_http_versions: [\"HTTP/1.1\", \"HTTP/2.0\"] 16 valid_status_codes: [] 17 method: POST 18 headers: 19 content-type: application/json 20 body: '{\"data\": \"one\"}' 21 preferred_ip_protocol: \"ip4\" 22 ip_protocol_fallback: false 23 fail_if_body_not_matches_regexp: [\".*one.*\"] 24 post_two_2xx: 25 prober: http 26 timeout: 5s 27 http: 28 valid_http_versions: [\"HTTP/1.1\", \"HTTP/2.0\"] 29 valid_status_codes: [] 30 method: POST 31 headers: 32 content-type: application/json 33 body: '{\"data\": \"two\"}' 34 preferred_ip_protocol: \"ip4\" 35 ip_protocol_fallback: false 36 fail_if_body_not_matches_regexp: [\".*two.*\"] Let‚Äôs run a blackbox exporter container with the above config and see if this works.\n1$ docker run --rm -d -p 9115:9115 --name blackbox_exporter -v `pwd`:/config prom/blackbox-exporter:master --config.file=/config/blackbox.yaml Blackbox exporter should now be available on http://localhost:9115/. The endpoint of interest to us is http://localhost:9115/probe. Hit the probe endpoint either through curl or on the browser\n1$ curl -s http://localhost:9115/probe?target=https://httpbin.org/post\u0026module=post_one_2xx You should get a page with quite a few metrics listed. Look for the probe_failed_due_to_regex 0 and probe_http_status_code 200 metrics, and if they are there, it means our config worked! üëè\nThe probe hit https://httpbin.org/post with the data as defined in post_one_2xx module, AND matched the regex as defined under the module property fail_if_body_not_matches_regexp.\nIf you were to switch, or change the regex pattern, so that the response body would not match it, probe_failed_due_to_regex 1 will be returned instead.\nNow that our blackbox exporter config is ready, let‚Äôs add the necessary config on Prometheus.\nStep 2 The prometheus.yaml configuration file which points to the blackbox exporter we have running from Step 1.\n1global: 2 scrape_interval: 1m 3scrape_configs: 4 - job_name: blackbox 5 metrics_path: /metrics 6 static_configs: 7 - targets: 8 - host.docker.internal:9115 9 - job_name: blackbox-http 10 metrics_path: /probe 11 scrape_interval: 5m 12 params: 13 module: [http_2xx] 14 static_configs: 15 - targets: 16 - https://httpbin.org 17 relabel_configs: 18 - source_labels: [__address__] 19 target_label: __param_target 20 - source_labels: [__param_target] 21 target_label: instance 22 - target_label: __address__ 23 replacement: host.docker.internal:9115 24 - job_name: blackbox-http-post-one 25 metrics_path: /probe 26 scrape_interval: 5m 27 params: 28 module: [post_one_2xx] 29 static_configs: 30 - targets: 31 - https://httpbin.org/post 32 relabel_configs: 33 - source_labels: [__address__] 34 target_label: __param_target 35 - source_labels: [__param_target] 36 target_label: instance 37 - target_label: __address__ 38 replacement: host.docker.internal:9115 39 - job_name: blackbox-http-post-two 40 metrics_path: /probe 41 scrape_interval: 5m 42 params: 43 module: [post_two_2xx] 44 static_configs: 45 - targets: 46 - https://httpbin.org/post 47 relabel_configs: 48 - source_labels: [__address__] 49 target_label: __param_target 50 - source_labels: [__param_target] 51 target_label: instance 52 - target_label: __address__ 53 replacement: host.docker.internal:9115 Let‚Äôs run a prometheus container with the above config and see all of this in action.\n1$ docker run --rm -d -p 9090:9090 --name prometheus -v `pwd`:/config prom/prometheus:latest --config.file=/config/prometheus.yaml Prometheus should now be available on http://localhost:9090/. Navigate to the targets page, to see it has picked up our blackbox exporter targets.\nOnce you have this integration going and Prometheus is scraping the Blackbox exporter, it is quite trivial to add more endpoints. Except ofcourse, when you want to monitor another API POST call. In that case, you need to start at step 1 again. Groundhog Day, eh? üôÉ\nConclusion That‚Äôs it!\nThis was a short post about using Prometheus Blackbox exporter to monitor different APIs.\nHope this post proves useful. üëç\nReferences (2) Blackbox Exporter¬†Multi Target Exporter¬†","wordCount":"733","inLanguage":"en","datePublished":"2021-09-28T00:00:00Z","dateModified":"2021-09-28T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://abiydv.github.io/posts/prometheus-blackbox-monitor-post-api/"},"publisher":{"@type":"Organization","name":"@abiydv","logo":{"@type":"ImageObject","url":"https://abiydv.github.io/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://abiydv.github.io/ accesskey=h title="@abiydv (Alt + H)">@abiydv</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://abiydv.github.io/ title=Home><span>Home</span></a></li><li><a href=https://abiydv.github.io/about/ title=About><span>About</span></a></li><li><a href=https://abiydv.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://abiydv.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://abiydv.github.io/notes/ title=Notes><span>Notes</span></a></li><li><a href=https://abiydv.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://abiydv.github.io/>Home</a>&nbsp;¬ª&nbsp;<a href=https://abiydv.github.io/posts/>Posts</a></div><h1 class=post-title>Prometheus Blackbox Exporter and POST calls</h1><div class=post-description>Monitor API POST calls using Prometheus and Blackbox exporter</div><div class=post-meta>28.9.21 / Posts / 4 min</div></header><div class=post-content><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p><a href=https://github.com/prometheus/blackbox_exporter>Prometheus Blackbox Exporter</a> is a popular plugin to test http endpoints. It offers a range of configuration options which can be tweaked to suit any use case. I recently had to implement monitoring for some APIs, each expecting a different content body.</p><h2 id=problem>Problem<a hidden class=anchor aria-hidden=true href=#problem>#</a></h2><p><a href=https://github.com/prometheus/blackbox_exporter/issues/380>By design</a>, Prometheus blackbox exporter is not expected to work as a &ldquo;proxy&rdquo;, so you cannot pass the body of a request via relabelling in Prometheus configs.</p><p>Let&rsquo;s say you want to monitor 2 APIs each of which expect you to provide a different payload. For this academic exercise, we can use <a href=https://httpbin.org/post>https://httpbin.org/post</a> as the API endpoint.</p><h2 id=solution>Solution<a hidden class=anchor aria-hidden=true href=#solution>#</a></h2><p>On a high level then, this needs 2 different steps -</p><ol><li>Add a new module in blackbox exporter configs</li><li>Add a new job in prometheus config to use the module created under 1.</li></ol><h3 id=step-1---blackbox-exporter>Step 1 - Blackbox Exporter<a hidden class=anchor aria-hidden=true href=#step-1---blackbox-exporter>#</a></h3><p>The <code>blackbox.yaml</code> configuration file with 2 new modules for each <code>post</code> request. Notice we also use the property <code>fail_if_body_not_matches_regexp</code>, which will fail our test if the response doesn&rsquo;t have the text we expect.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#f92672>modules</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#f92672>http_2xx</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#f92672>prober</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#f92672>timeout</span>: <span style=color:#ae81ff>5s</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>      <span style=color:#f92672>valid_http_versions</span>: [<span style=color:#e6db74>&#34;HTTP/1.1&#34;</span>, <span style=color:#e6db74>&#34;HTTP/2.0&#34;</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>      <span style=color:#f92672>valid_status_codes</span>: []
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>      <span style=color:#f92672>method</span>: <span style=color:#ae81ff>GET</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>      <span style=color:#f92672>preferred_ip_protocol</span>: <span style=color:#e6db74>&#34;ip4&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>      <span style=color:#f92672>ip_protocol_fallback</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  <span style=color:#f92672>post_one_2xx</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#f92672>prober</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#f92672>timeout</span>: <span style=color:#ae81ff>5s</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>      <span style=color:#f92672>valid_http_versions</span>: [<span style=color:#e6db74>&#34;HTTP/1.1&#34;</span>, <span style=color:#e6db74>&#34;HTTP/2.0&#34;</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>      <span style=color:#f92672>valid_status_codes</span>: []
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>      <span style=color:#f92672>method</span>: <span style=color:#ae81ff>POST</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>      <span style=color:#f92672>headers</span>: 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#f92672>content-type</span>: <span style=color:#ae81ff>application/json</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>      <span style=color:#f92672>body</span>: <span style=color:#e6db74>&#39;{&#34;data&#34;: &#34;one&#34;}&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>      <span style=color:#f92672>preferred_ip_protocol</span>: <span style=color:#e6db74>&#34;ip4&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>      <span style=color:#f92672>ip_protocol_fallback</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>      <span style=color:#f92672>fail_if_body_not_matches_regexp</span>: [<span style=color:#e6db74>&#34;.*one.*&#34;</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>  <span style=color:#f92672>post_two_2xx</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    <span style=color:#f92672>prober</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    <span style=color:#f92672>timeout</span>: <span style=color:#ae81ff>5s</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>      <span style=color:#f92672>valid_http_versions</span>: [<span style=color:#e6db74>&#34;HTTP/1.1&#34;</span>, <span style=color:#e6db74>&#34;HTTP/2.0&#34;</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>      <span style=color:#f92672>valid_status_codes</span>: []
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>      <span style=color:#f92672>method</span>: <span style=color:#ae81ff>POST</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>      <span style=color:#f92672>headers</span>: 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>        <span style=color:#f92672>content-type</span>: <span style=color:#ae81ff>application/json</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>      <span style=color:#f92672>body</span>: <span style=color:#e6db74>&#39;{&#34;data&#34;: &#34;two&#34;}&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>      <span style=color:#f92672>preferred_ip_protocol</span>: <span style=color:#e6db74>&#34;ip4&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>      <span style=color:#f92672>ip_protocol_fallback</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>      <span style=color:#f92672>fail_if_body_not_matches_regexp</span>: [<span style=color:#e6db74>&#34;.*two.*&#34;</span>]
</span></span></code></pre></div><p>Let&rsquo;s run a blackbox exporter container with the above config and see if this works.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ docker run --rm -d -p 9115:9115 --name blackbox_exporter -v <span style=color:#e6db74>`</span>pwd<span style=color:#e6db74>`</span>:/config prom/blackbox-exporter:master --config.file<span style=color:#f92672>=</span>/config/blackbox.yaml
</span></span></code></pre></div><p>Blackbox exporter should now be available on <code>http://localhost:9115/</code>. The endpoint of interest to us is <code>http://localhost:9115/probe</code>. Hit the probe endpoint either through <a href=/posts/curl-cheatsheet/>curl</a> or on the browser</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ curl -s http://localhost:9115/probe?target<span style=color:#f92672>=</span>https://httpbin.org/post&amp;module<span style=color:#f92672>=</span>post_one_2xx
</span></span></code></pre></div><p><img loading=lazy src=../../images/blackbox-local.png alt=blackbox-local></p><p>You should get a page with quite a few metrics listed. Look for the <code>probe_failed_due_to_regex 0</code> and <code>probe_http_status_code 200</code> metrics, and if they are there, it means our config worked! &#x1f44f;</p><p>The probe hit <code>https://httpbin.org/post</code> with the data as defined in <code>post_one_2xx</code> module, AND matched the regex as defined under the module property <code>fail_if_body_not_matches_regexp</code>.</p><p>If you were to switch, or change the regex pattern, so that the response body would not match it, <code>probe_failed_due_to_regex 1</code> will be returned instead.</p><p>Now that our blackbox exporter config is ready, let&rsquo;s add the necessary config on Prometheus.</p><h3 id=step-2>Step 2<a hidden class=anchor aria-hidden=true href=#step-2>#</a></h3><p>The <code>prometheus.yaml</code> configuration file which points to the blackbox exporter we have running from <a href=/posts/prometheus-blackbox-monitor-post-api/#step-1---blackbox-exporter>Step 1</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#f92672>global</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#f92672>scrape_interval</span>: <span style=color:#ae81ff>1m</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f92672>scrape_configs</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  - <span style=color:#f92672>job_name</span>: <span style=color:#ae81ff>blackbox</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#f92672>metrics_path</span>: <span style=color:#ae81ff>/metrics</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#f92672>static_configs</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    - <span style=color:#f92672>targets</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>      - <span style=color:#ae81ff>host.docker.internal:9115</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  - <span style=color:#f92672>job_name</span>: <span style=color:#ae81ff>blackbox-http</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#f92672>metrics_path</span>: <span style=color:#ae81ff>/probe</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#f92672>scrape_interval</span>: <span style=color:#ae81ff>5m</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>      <span style=color:#f92672>module</span>: [<span style=color:#ae81ff>http_2xx]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#f92672>static_configs</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>      - <span style=color:#f92672>targets</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        - <span style=color:#ae81ff>https://httpbin.org</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#f92672>relabel_configs</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>      - <span style=color:#f92672>source_labels</span>: [<span style=color:#ae81ff>__address__]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#f92672>target_label</span>: <span style=color:#ae81ff>__param_target</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>      - <span style=color:#f92672>source_labels</span>: [<span style=color:#ae81ff>__param_target]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#f92672>target_label</span>: <span style=color:#ae81ff>instance</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>      - <span style=color:#f92672>target_label</span>: <span style=color:#ae81ff>__address__</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        <span style=color:#f92672>replacement</span>: <span style=color:#ae81ff>host.docker.internal:9115</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>  - <span style=color:#f92672>job_name</span>: <span style=color:#ae81ff>blackbox-http-post-one</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    <span style=color:#f92672>metrics_path</span>: <span style=color:#ae81ff>/probe</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    <span style=color:#f92672>scrape_interval</span>: <span style=color:#ae81ff>5m</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>      <span style=color:#f92672>module</span>: [<span style=color:#ae81ff>post_one_2xx]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>    <span style=color:#f92672>static_configs</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>      - <span style=color:#f92672>targets</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>        - <span style=color:#ae81ff>https://httpbin.org/post</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    <span style=color:#f92672>relabel_configs</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>      - <span style=color:#f92672>source_labels</span>: [<span style=color:#ae81ff>__address__]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>        <span style=color:#f92672>target_label</span>: <span style=color:#ae81ff>__param_target</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>      - <span style=color:#f92672>source_labels</span>: [<span style=color:#ae81ff>__param_target]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>        <span style=color:#f92672>target_label</span>: <span style=color:#ae81ff>instance</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>      - <span style=color:#f92672>target_label</span>: <span style=color:#ae81ff>__address__</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>        <span style=color:#f92672>replacement</span>: <span style=color:#ae81ff>host.docker.internal:9115</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>  - <span style=color:#f92672>job_name</span>: <span style=color:#ae81ff>blackbox-http-post-two</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>    <span style=color:#f92672>metrics_path</span>: <span style=color:#ae81ff>/probe</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>    <span style=color:#f92672>scrape_interval</span>: <span style=color:#ae81ff>5m</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>    <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>      <span style=color:#f92672>module</span>: [<span style=color:#ae81ff>post_two_2xx]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>    <span style=color:#f92672>static_configs</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>      - <span style=color:#f92672>targets</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>        - <span style=color:#ae81ff>https://httpbin.org/post</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>    <span style=color:#f92672>relabel_configs</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>      - <span style=color:#f92672>source_labels</span>: [<span style=color:#ae81ff>__address__]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>        <span style=color:#f92672>target_label</span>: <span style=color:#ae81ff>__param_target</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>      - <span style=color:#f92672>source_labels</span>: [<span style=color:#ae81ff>__param_target]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>        <span style=color:#f92672>target_label</span>: <span style=color:#ae81ff>instance</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>      - <span style=color:#f92672>target_label</span>: <span style=color:#ae81ff>__address__</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>        <span style=color:#f92672>replacement</span>: <span style=color:#ae81ff>host.docker.internal:9115</span>
</span></span></code></pre></div><p>Let&rsquo;s run a prometheus container with the above config and see all of this in action.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ docker run --rm -d -p 9090:9090 --name prometheus -v <span style=color:#e6db74>`</span>pwd<span style=color:#e6db74>`</span>:/config prom/prometheus:latest --config.file<span style=color:#f92672>=</span>/config/prometheus.yaml
</span></span></code></pre></div><p>Prometheus should now be available on <code>http://localhost:9090/</code>. Navigate to the targets page, to see it has picked up our blackbox exporter targets.</p><p><img loading=lazy src=../../images/prometheus-local.png alt=prometheus-local></p><p>Once you have this integration going and Prometheus is scraping the Blackbox exporter, it is quite trivial to add more endpoints. Except ofcourse, when you want to monitor another API POST call. In that case, you need to start at <a href=/posts/prometheus-blackbox-monitor-post-api/#step-1---blackbox-exporter>step 1</a> again. Groundhog Day, eh? &#x1f643;</p><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>That&rsquo;s it!</p><p>This was a short post about using Prometheus Blackbox exporter to monitor different APIs.</p><p>Hope this post proves useful. &#x1f44d;</p><h2>References (2)</h2><ol class=slimlist-ol><li class=slimlist-ol><a aria-label="link to https://github.com/prometheus/blackbox_exporter" target=_blank href=https://github.com/prometheus/blackbox_exporter>Blackbox Exporter&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li class=slimlist-ol><a aria-label="link to https://prometheus.io/docs/guides/multi-target-exporter" target=_blank href=https://prometheus.io/docs/guides/multi-target-exporter>Multi Target Exporter&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ol></div><footer class=post-footer><hr><div class=align-center><div class=slimlist-entry><h2>Tags</h2></div><ul class=post-tags><div class=slimlist-entry><li class=post-tags><a href=https://abiydv.github.io/tags/prometheus/>prometheus</a></li><li class=post-tags><a href=https://abiydv.github.io/tags/blackbox/>blackbox</a></li><li class=post-tags><a href=https://abiydv.github.io/tags/cncf/>cncf</a></li><li class=post-tags><a href=https://abiydv.github.io/tags/monitoring/>monitoring</a></li></div></ul></div></footer><script src=https://utteranc.es/client.js repo=abiydv/abiydv.github.io issue-term=title label=Comment theme=github-light crossorigin=anonymous async></script><hr><div class=align-left><div class=slimlist-entry><h2>Related</h2></div><ul class=slimlist><li class=slimlist><div class=slimlist-entry><h3 class=slimlist-entry-title><a aria-label="post link to Elasticsearch Ingest Pipelines" href=https://abiydv.github.io/posts/elasticsearch-ingest-pipelines/>Elasticsearch Ingest Pipelines</a></h3><div class=slimlist-meta>12.9.19 / Posts / 6 min</div></div></li></ul></div></article></main><footer class=footer><span>&copy; 2019-2025 <a href=https://abiydv.github.io/>@abiydv</a> / </span><span>Published 4.4.25 /
</span><span>Thanks <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a>, <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>