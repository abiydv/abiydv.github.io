<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Terraform, Bitbucket pipelines and OIDC | @abiydv</title>
<meta name=keywords content="bitbucket,pipelines,aws,terraform,cloudformation,cicd"><meta name=description content="How to setup a Terraform CI/CD in Bitbucket pipeline using OIDC role based access"><meta name=author content><link rel=canonical href=https://abiydv.github.io/posts/terraform-bitbucket-pipeline-oidc/><link crossorigin=anonymous href=/assets/css/stylesheet.c5edd088d0c984c192170cfbab7d2de030010ee0b7d771bd6bca049dd2332874.css integrity="sha256-xe3QiNDJhMGSFwz7q30t4DABDuC313G9a8oEndIzKHQ=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://abiydv.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://abiydv.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://abiydv.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://abiydv.github.io/apple-touch-icon.png><link rel=mask-icon href=https://abiydv.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://abiydv.github.io/posts/terraform-bitbucket-pipeline-oidc/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Terraform, Bitbucket pipelines and OIDC"><meta property="og:description" content="How to setup a Terraform CI/CD in Bitbucket pipeline using OIDC role based access"><meta property="og:type" content="article"><meta property="og:url" content="https://abiydv.github.io/posts/terraform-bitbucket-pipeline-oidc/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-09-30T00:00:00+00:00"><meta property="article:modified_time" content="2021-09-30T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Terraform, Bitbucket pipelines and OIDC"><meta name=twitter:description content="How to setup a Terraform CI/CD in Bitbucket pipeline using OIDC role based access"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://abiydv.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Terraform, Bitbucket pipelines and OIDC","item":"https://abiydv.github.io/posts/terraform-bitbucket-pipeline-oidc/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Terraform, Bitbucket pipelines and OIDC","name":"Terraform, Bitbucket pipelines and OIDC","description":"How to setup a Terraform CI/CD in Bitbucket pipeline using OIDC role based access","keywords":["bitbucket","pipelines","aws","terraform","cloudformation","cicd"],"articleBody":"Introduction Bitbucket Pipelines is often the ci-cd tool of choice for organisations which are already entrenched into the Atlassian suite of products. No one is thrilled at the prospect, but hey, you got to play the hand you have been dealt. So, here we go.\nProblem One of the key problems with establishing a CI/CD infrastructure flow is that of access control. Specifically for Bitbucket Pipelines, in the past you would need to provide access via repository variables. These would include a access_key and secret_key which would grant it the necessary permission to do the changes as part of the Terraform run.\nSolution Bitbucket Pipelines now support a OIDC role based access flow for AWS, so you don’t need to manage a robot user and it’s key rotation. In this post, I’ll desribe how I went about enabling this flow in our project.\nStep 1 - Setting up the basics in AWS First up, you need to create the basics for use with Bitbucket Pipeline. I use a Cloudformation template to deploy the resources necessary for terraform run like S3 and Dynamodb. To this template we will add the required OIDC provider and an IAM role as well.\nI use the following template, you can modify it suitably for any further customizations necessary\n1AWSTemplateFormatVersion: 2010-09-09 2Description: Basic resources for Terraform 3Resources: 4 TFBucket: 5 Type: AWS::S3::Bucket 6 Properties: 7 AccessControl: Private 8 BucketEncryption: 9 ServerSideEncryptionConfiguration: 10 - ServerSideEncryptionByDefault: 11 SSEAlgorithm: AES256 12 PublicAccessBlockConfiguration: 13 BlockPublicAcls: true 14 BlockPublicPolicy: true 15 IgnorePublicAcls: true 16 RestrictPublicBuckets: true 17 VersioningConfiguration: 18 Status: Enabled 19 Tags: 20 - Key: Purpose 21 Value: \"Terraform state file remote storage\" 22 TFDynamoDBTable: 23 Type: AWS::DynamoDB::Table 24 Properties: 25 BillingMode: PAY_PER_REQUEST 26 SSESpecification: 27 SSEEnabled: true 28 TableName: terraform-remote-state 29 AttributeDefinitions: 30 - AttributeName: LockID 31 AttributeType: S 32 KeySchema: 33 - AttributeName: LockID 34 KeyType: HASH 35 Tags: 36 - Key: Purpose 37 Value: \"Terraform state file remote storage\" 38 BBOidc: 39 Type: AWS::IAM::OIDCProvider 40 Properties: 41 ClientIdList: 42 - 'AUDIENCE' 43 Tags: 44 - Key: Purpose 45 Value: \"Bitbucket pipelines to assume IAM role\" 46 ThumbprintList: 47 - 'THUMBPRINT' 48 Url: 'IDENTITY PROVIDER URL' 49 TFRole: 50 Type: AWS::IAM::Role 51 Properties: 52 AssumeRolePolicyDocument: 53 Version: \"2012-10-17\" 54 Statement: 55 - Effect: Allow 56 Principal: 57 Federated: 58 - !Ref BBOidc 59 Action: 60 - 'sts:AssumeRoleWithWebIdentity' 61 62 RoleName: terraform-iam-role 63 Tags: 64 - Key: Purpose 65 Value: \"Access for Bitbucket Pipelines\" 66 TFPolicy: 67 Type: AWS::IAM::Policy 68 Properties: 69 PolicyName: terraform-base-policy 70 Roles: 71 - !Ref TFRole 72 PolicyDocument: 73 Version: '2012-10-17' 74 Statement: 75 - Effect: Allow 76 Action: 77 - 's3:ListBucket' 78 - 's3:GetObject' 79 - 's3:PutObject' 80 - 's3:PutObjectAcl' 81 Resource: 82 - !Sub 'arn:aws:s3:::${TFBucket}' 83 - !Sub 'arn:aws:s3:::${TFBucket}/*' 84 - Effect: Allow 85 Action: 86 - 'dynamodb:GetItem' 87 - 'dynamodb:PutItem' 88 - 'dynamodb:DeleteItem' 89 Resource: 90 - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${TFDynamoDBTable}' 91 CBPolicy: 92 Type: AWS::IAM::Policy 93 Properties: 94 PolicyName: codebuild-access-policy 95 Roles: 96 - !Ref TFRole 97 PolicyDocument: 98 Version: '2012-10-17' 99 Statement: 100 - Effect: Allow 101 Action: 102 - 'codebuild:CreateProject' 103 - 'codebuild:DeleteProject' 104 - 'codebuild:UpdateProject' 105 - 'codebuild:CreateWebhook' 106 - 'codebuild:DeleteWebhook' 107 - 'codebuild:UpdateWebhook' 108 - 'codebuild:BatchGetProjects' 109 Resource: 110 - !Sub 'arn:aws:codebuild:${AWS::Region}:${AWS::AccountId}:project/*' 111 - Effect: Allow 112 Action: 113 - 'codebuild:ImportSourceCredentials' 114 - 'codebuild:DeleteSourceCredentials' 115 - 'codebuild:ListProjects' 116 - 'codebuild:ListCuratedEnvironmentImages' 117 Resource: '*' 118 IAMPolicy: 119 Type: AWS::IAM::Policy 120 Properties: 121 PolicyName: iam-access-policy 122 Roles: 123 - !Ref TFRole 124 PolicyDocument: 125 Version: '2012-10-17' 126 Statement: 127 - Effect: Allow 128 Action: 129 - 'iam:List*' 130 - 'iam:PassRole' 131 - 'iam:GetRole*' 132 Resource: 133 - !Sub 'arn:aws:iam::${AWS::AccountId}:role/*' 134 S3Policy: 135 Type: AWS::IAM::Policy 136 Properties: 137 PolicyName: s3-access-policy 138 Roles: 139 - !Ref TFRole 140 PolicyDocument: 141 Version: '2012-10-17' 142 Statement: 143 - Effect: Allow 144 Action: 145 - 's3:List*' 146 - 's3:GetObject*' 147 - 's3:PutObject' 148 - 's3:PutObjectAcl' 149 Resource: 150 - 'arn:aws:s3:::bucket' 151 - 'arn:aws:s3:::bucket/*' As you can see, the template creates -\nAn S3 bucket which will be used to save the terraform state A Dynamodb table for terraform state locking An OIDC provider for Bitbucket pipelines to use IAM Role and policies to provide necessary access to Bitbucket pipelines The policies CBPolicy, IAMPolicy, S3Policy provide appropriate permissions to create and manage a codebuild project. These will ofcourse vary, depending on what you plan to manage with Terraform. For the BBOidc resource, replace the values AUDIENCE, IDENTITY PROVIDER URL and THUMBPRINT. These can be obtained from Bitbucket under Repository settings. Details are here Once this template is deployed, we have the necessary basics setup to start setting up the pipeline on Bitbucket. Bear in mind though, this is more of an academic exercise. If you plan to roll this out in production, you should probably look at securing this role further. By defining conditions in the role’s IAM trust policy to tie down the scope to a particular repo or workspace, as well as possibly restricting it by IPs.\nStep 2 - Terraform Configs I will just share the provider block to keep it short, you can build up on this to create any necessary AWS resources. Be sure to modify the Cloudformation stack above for the proper permissions.\n1# Backend config for remote_state 2terraform { 3 backend \"s3\" { 4 bucket = \"BUCKET_FROM_CFTEMPLATE\" 5 key = \"DYNAMODB_KEY\" 6 region = \"REPLACE_WITH_REGION_TO_USE\" 7 encrypt = true 8 dynamodb_table = \"DYNAMODB_FROM_CFTEMPLATE\" 9 } 10 required_providers { 11 aws = { 12 source = \"hashicorp/aws\" 13 version = \"~\u003e 3.0\" 14 } 15 } 16} 17# Configure aws provider 18provider \"aws\" { 19 region = \"REPLACE_WITH_REGION_TO_USE\" 20} You will need to replace BUCKET_FROM_CFTEMPLATE, DYNAMODB_FROM_CFTEMPLATE, DYNAMODB_KEY, REPLACE_WITH_REGION_TO_USE. The Dynamodb and S3 bucket are created in Step 1, just copy over the values from there.\nStep 3 - Configure Bitbucket Pipeline Right, now to the heart of the matter - configuring Bitbucket pipeline. It is fairly simple, you just need to add a file bibucket-pipelines.yml in the same Bitbucket repo as your terraform code. The one I used is included below.\n1image: hashicorp/terraform:1.0.7 2definitions: 3 scripts: 4 - script: \u0026aws-context 5 export AWS_REGION=REPLACE_WITH_REGION_TO_USE; 6 export AWS_WEB_IDENTITY_TOKEN_FILE=$(pwd)/web-identity-token; 7 export AWS_ROLE_SESSION_NAME=build-session; 8 export AWS_ROLE_ARN=REPLACE_WITH_ROLE_ARN_TO_USE; 9 echo $BITBUCKET_STEP_OIDC_TOKEN \u003e $(pwd)/web-identity-token 10 steps: 11 - step: \u0026validate 12 name: Validate Terraform config 13 oidc: true 14 script: 15 - terraform init -backend=false 16 - terraform validate 17 - step: \u0026plan 18 name: Terraform Plan 19 oidc: true 20 script: 21 - *aws-context 22 - terraform init 23 - terraform plan -input=false -out=tfplan.out 24 artifacts: 25 - tfplan.out 26 - step: \u0026apply 27 name: Terraform Apply 28 oidc: true 29 trigger: manual 30 script: 31 - *aws-context 32 - terraform init 33 - terraform apply -input=false -auto-approve tfplan.out 34pipelines: 35 branches: 36 main: 37 - step: *validate 38 - step: *plan 39 - step: *apply 40 default: 41 - step: *validate There is a lot going on in there, so I’ll try to break it down a bit.\nFirst up are the definitions - Resources here can be resued in your pipeline using yaml anchor. So this is a good place to declare stuff you know you will be calling often. In this case, I have declared a script which sets up the environment variables necessary for the OIDC role flow to work. Yes, you need to attach this to EVERY step which needs access to AWS via the OIDC role.\nSecond, notice the flag oidc: true that is applied to all the steps that need access to AWS resources. This possibly tells Bitbucket to kick off some magic in the backend and populate all the environment variables we set up above.\nThird, I use artifacts to pass on the plan output from one step to the next. This is resued when you run the apply step.\nFourth, I have a flag trigger: manual on the terraform apply step. This ensures the apply step is only triggered after a careful review of the plan step above. But you can always remove it to trigger the apply as soon as plan succeeds.\nAnd that’s it really! Now everytime you commit a change to the repo, you should see a pipeline run triggered.\nConclusion I hope this post proves useful to setup a OIDC role based access control for Bitbucket pipelines. There are a plethora of customization options available for them including running the builds on self hosted runners. So feel free to go through their docs to find out more, I will include the useful links below.\nReferences (3) Configure Your Pipeline Integrate Pipelines With Resource Servers Using Oidc Deploy on Aws Using Bitbucket Pipelines Openid Connect ","wordCount":"1430","inLanguage":"en","datePublished":"2021-09-30T00:00:00Z","dateModified":"2021-09-30T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://abiydv.github.io/posts/terraform-bitbucket-pipeline-oidc/"},"publisher":{"@type":"Organization","name":"@abiydv","logo":{"@type":"ImageObject","url":"https://abiydv.github.io/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://abiydv.github.io/ accesskey=h title="@abiydv (Alt + H)">@abiydv</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://abiydv.github.io/ title=Home><span>Home</span></a></li><li><a href=https://abiydv.github.io/about/ title=About><span>About</span></a></li><li><a href=https://abiydv.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://abiydv.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://abiydv.github.io/notes/ title=Notes><span>Notes</span></a></li><li><a href=https://abiydv.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://abiydv.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://abiydv.github.io/posts/>Posts</a></div><h1 class=post-title>Terraform, Bitbucket pipelines and OIDC</h1><div class=post-description>How to setup a Terraform CI/CD in Bitbucket pipeline using OIDC role based access</div><div class=post-meta>30.9.21 / Posts / 7 min</div></header><div class=post-content><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p><a href=https://bitbucket.org/product/features/pipelines>Bitbucket Pipelines</a> is often the ci-cd tool of choice for organisations which are already entrenched into the Atlassian suite of products. <em>No one</em> is thrilled at the prospect, but hey, you got to play the hand you have been dealt. So, here we go.</p><p><img loading=lazy src=../../images/bitbucket-pipelines.png alt=bitbucket-pipelines></p><h2 id=problem>Problem<a hidden class=anchor aria-hidden=true href=#problem>#</a></h2><p>One of the key problems with establishing a CI/CD infrastructure flow is that of access control. Specifically for Bitbucket Pipelines, in the past you would need to provide access via repository variables. These would include a <code>access_key</code> and <code>secret_key</code> which would grant it the necessary permission to do the changes as part of the Terraform run.</p><h2 id=solution>Solution<a hidden class=anchor aria-hidden=true href=#solution>#</a></h2><p>Bitbucket Pipelines now support a OIDC role based access flow for AWS, so you don&rsquo;t need to manage a robot user and it&rsquo;s key rotation. In this post, I&rsquo;ll desribe how I went about enabling this flow in our project.</p><h3 id=step-1---setting-up-the-basics-in-aws>Step 1 - Setting up the basics in AWS<a hidden class=anchor aria-hidden=true href=#step-1---setting-up-the-basics-in-aws>#</a></h3><p>First up, you need to create the basics for use with Bitbucket Pipeline. I use a Cloudformation template to deploy the resources necessary for terraform run like S3 and Dynamodb. To this template we will add the required OIDC provider and an IAM role as well.</p><p>I use the following template, you can modify it suitably for any further customizations necessary</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1</span><span><span style=color:#f92672>AWSTemplateFormatVersion</span>: <span style=color:#e6db74>2010-09-09</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2</span><span><span style=color:#f92672>Description</span>: <span style=color:#ae81ff>Basic resources for Terraform</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3</span><span><span style=color:#f92672>Resources</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4</span><span>  <span style=color:#f92672>TFBucket</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5</span><span>    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::S3::Bucket</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6</span><span>    <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7</span><span>      <span style=color:#f92672>AccessControl</span>: <span style=color:#ae81ff>Private</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8</span><span>      <span style=color:#f92672>BucketEncryption</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9</span><span>        <span style=color:#f92672>ServerSideEncryptionConfiguration</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10</span><span>          - <span style=color:#f92672>ServerSideEncryptionByDefault</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11</span><span>              <span style=color:#f92672>SSEAlgorithm</span>: <span style=color:#ae81ff>AES256</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12</span><span>      <span style=color:#f92672>PublicAccessBlockConfiguration</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13</span><span>        <span style=color:#f92672>BlockPublicAcls</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14</span><span>        <span style=color:#f92672>BlockPublicPolicy</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15</span><span>        <span style=color:#f92672>IgnorePublicAcls</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16</span><span>        <span style=color:#f92672>RestrictPublicBuckets</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17</span><span>      <span style=color:#f92672>VersioningConfiguration</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18</span><span>        <span style=color:#f92672>Status</span>: <span style=color:#ae81ff>Enabled</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19</span><span>      <span style=color:#f92672>Tags</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20</span><span>        - <span style=color:#f92672>Key</span>: <span style=color:#ae81ff>Purpose</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21</span><span>          <span style=color:#f92672>Value</span>: <span style=color:#e6db74>&#34;Terraform state file remote storage&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22</span><span>  <span style=color:#f92672>TFDynamoDBTable</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23</span><span>    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::DynamoDB::Table</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24</span><span>    <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25</span><span>      <span style=color:#f92672>BillingMode</span>: <span style=color:#ae81ff>PAY_PER_REQUEST</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26</span><span>      <span style=color:#f92672>SSESpecification</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27</span><span>        <span style=color:#f92672>SSEEnabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28</span><span>      <span style=color:#f92672>TableName</span>: <span style=color:#ae81ff>terraform-remote-state</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29</span><span>      <span style=color:#f92672>AttributeDefinitions</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30</span><span>        - <span style=color:#f92672>AttributeName</span>: <span style=color:#ae81ff>LockID</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31</span><span>          <span style=color:#f92672>AttributeType</span>: <span style=color:#ae81ff>S</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32</span><span>      <span style=color:#f92672>KeySchema</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33</span><span>         - <span style=color:#f92672>AttributeName</span>: <span style=color:#ae81ff>LockID</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34</span><span>           <span style=color:#f92672>KeyType</span>: <span style=color:#ae81ff>HASH</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35</span><span>      <span style=color:#f92672>Tags</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36</span><span>        - <span style=color:#f92672>Key</span>: <span style=color:#ae81ff>Purpose</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37</span><span>          <span style=color:#f92672>Value</span>: <span style=color:#e6db74>&#34;Terraform state file remote storage&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38</span><span>  <span style=color:#f92672>BBOidc</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39</span><span>    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::IAM::OIDCProvider</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40</span><span>    <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41</span><span>      <span style=color:#f92672>ClientIdList</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42</span><span>        - <span style=color:#e6db74>&#39;AUDIENCE&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43</span><span>      <span style=color:#f92672>Tags</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44</span><span>        - <span style=color:#f92672>Key</span>: <span style=color:#ae81ff>Purpose</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45</span><span>          <span style=color:#f92672>Value</span>: <span style=color:#e6db74>&#34;Bitbucket pipelines to assume IAM role&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46</span><span>      <span style=color:#f92672>ThumbprintList</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47</span><span>        - <span style=color:#e6db74>&#39;THUMBPRINT&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48</span><span>      <span style=color:#f92672>Url</span>: <span style=color:#e6db74>&#39;IDENTITY PROVIDER URL&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49</span><span>  <span style=color:#f92672>TFRole</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50</span><span>    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::IAM::Role</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51</span><span>    <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52</span><span>      <span style=color:#f92672>AssumeRolePolicyDocument</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53</span><span>        <span style=color:#f92672>Version</span>: <span style=color:#e6db74>&#34;2012-10-17&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54</span><span>        <span style=color:#f92672>Statement</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55</span><span>          - <span style=color:#f92672>Effect</span>: <span style=color:#ae81ff>Allow</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56</span><span>            <span style=color:#f92672>Principal</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57</span><span>              <span style=color:#f92672>Federated</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58</span><span>                - !<span style=color:#ae81ff>Ref BBOidc</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59</span><span>            <span style=color:#f92672>Action</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60</span><span>              - <span style=color:#e6db74>&#39;sts:AssumeRoleWithWebIdentity&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62</span><span>      <span style=color:#f92672>RoleName</span>: <span style=color:#ae81ff>terraform-iam-role</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63</span><span>      <span style=color:#f92672>Tags</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64</span><span>        - <span style=color:#f92672>Key</span>: <span style=color:#ae81ff>Purpose</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65</span><span>          <span style=color:#f92672>Value</span>: <span style=color:#e6db74>&#34;Access for Bitbucket Pipelines&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66</span><span>  <span style=color:#f92672>TFPolicy</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67</span><span>    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::IAM::Policy</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68</span><span>    <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69</span><span>      <span style=color:#f92672>PolicyName</span>: <span style=color:#ae81ff>terraform-base-policy</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70</span><span>      <span style=color:#f92672>Roles</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71</span><span>        - !<span style=color:#ae81ff>Ref TFRole</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72</span><span>      <span style=color:#f92672>PolicyDocument</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73</span><span>        <span style=color:#f92672>Version</span>: <span style=color:#e6db74>&#39;2012-10-17&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74</span><span>        <span style=color:#f92672>Statement</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75</span><span>        - <span style=color:#f92672>Effect</span>: <span style=color:#ae81ff>Allow</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76</span><span>          <span style=color:#f92672>Action</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77</span><span>            - <span style=color:#e6db74>&#39;s3:ListBucket&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78</span><span>            - <span style=color:#e6db74>&#39;s3:GetObject&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79</span><span>            - <span style=color:#e6db74>&#39;s3:PutObject&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80</span><span>            - <span style=color:#e6db74>&#39;s3:PutObjectAcl&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81</span><span>          <span style=color:#f92672>Resource</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82</span><span>            - !<span style=color:#ae81ff>Sub &#39;arn:aws:s3:::${TFBucket}&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83</span><span>            - !<span style=color:#ae81ff>Sub &#39;arn:aws:s3:::${TFBucket}/*&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84</span><span>        - <span style=color:#f92672>Effect</span>: <span style=color:#ae81ff>Allow</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85</span><span>          <span style=color:#f92672>Action</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86</span><span>            - <span style=color:#e6db74>&#39;dynamodb:GetItem&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87</span><span>            - <span style=color:#e6db74>&#39;dynamodb:PutItem&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88</span><span>            - <span style=color:#e6db74>&#39;dynamodb:DeleteItem&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89</span><span>          <span style=color:#f92672>Resource</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90</span><span>            - !<span style=color:#ae81ff>Sub &#39;arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${TFDynamoDBTable}&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91</span><span>  <span style=color:#f92672>CBPolicy</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92</span><span>    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::IAM::Policy</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93</span><span>    <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94</span><span>      <span style=color:#f92672>PolicyName</span>: <span style=color:#ae81ff>codebuild-access-policy</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95</span><span>      <span style=color:#f92672>Roles</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96</span><span>        - !<span style=color:#ae81ff>Ref TFRole</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97</span><span>      <span style=color:#f92672>PolicyDocument</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98</span><span>        <span style=color:#f92672>Version</span>: <span style=color:#e6db74>&#39;2012-10-17&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99</span><span>        <span style=color:#f92672>Statement</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100</span><span>        - <span style=color:#f92672>Effect</span>: <span style=color:#ae81ff>Allow</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101</span><span>          <span style=color:#f92672>Action</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102</span><span>            - <span style=color:#e6db74>&#39;codebuild:CreateProject&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103</span><span>            - <span style=color:#e6db74>&#39;codebuild:DeleteProject&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104</span><span>            - <span style=color:#e6db74>&#39;codebuild:UpdateProject&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105</span><span>            - <span style=color:#e6db74>&#39;codebuild:CreateWebhook&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106</span><span>            - <span style=color:#e6db74>&#39;codebuild:DeleteWebhook&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107</span><span>            - <span style=color:#e6db74>&#39;codebuild:UpdateWebhook&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108</span><span>            - <span style=color:#e6db74>&#39;codebuild:BatchGetProjects&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109</span><span>          <span style=color:#f92672>Resource</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110</span><span>            - !<span style=color:#ae81ff>Sub &#39;arn:aws:codebuild:${AWS::Region}:${AWS::AccountId}:project/*&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111</span><span>        - <span style=color:#f92672>Effect</span>: <span style=color:#ae81ff>Allow</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112</span><span>          <span style=color:#f92672>Action</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113</span><span>            - <span style=color:#e6db74>&#39;codebuild:ImportSourceCredentials&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114</span><span>            - <span style=color:#e6db74>&#39;codebuild:DeleteSourceCredentials&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115</span><span>            - <span style=color:#e6db74>&#39;codebuild:ListProjects&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116</span><span>            - <span style=color:#e6db74>&#39;codebuild:ListCuratedEnvironmentImages&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117</span><span>          <span style=color:#f92672>Resource</span>: <span style=color:#e6db74>&#39;*&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118</span><span>  <span style=color:#f92672>IAMPolicy</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119</span><span>    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::IAM::Policy</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120</span><span>    <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121</span><span>      <span style=color:#f92672>PolicyName</span>: <span style=color:#ae81ff>iam-access-policy</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122</span><span>      <span style=color:#f92672>Roles</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123</span><span>        - !<span style=color:#ae81ff>Ref TFRole</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124</span><span>      <span style=color:#f92672>PolicyDocument</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125</span><span>        <span style=color:#f92672>Version</span>: <span style=color:#e6db74>&#39;2012-10-17&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126</span><span>        <span style=color:#f92672>Statement</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127</span><span>        - <span style=color:#f92672>Effect</span>: <span style=color:#ae81ff>Allow</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128</span><span>          <span style=color:#f92672>Action</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129</span><span>            - <span style=color:#e6db74>&#39;iam:List*&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130</span><span>            - <span style=color:#e6db74>&#39;iam:PassRole&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131</span><span>            - <span style=color:#e6db74>&#39;iam:GetRole*&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132</span><span>          <span style=color:#f92672>Resource</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133</span><span>            - !<span style=color:#ae81ff>Sub &#39;arn:aws:iam::${AWS::AccountId}:role/*&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134</span><span>  <span style=color:#f92672>S3Policy</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135</span><span>    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::IAM::Policy</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136</span><span>    <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137</span><span>      <span style=color:#f92672>PolicyName</span>: <span style=color:#ae81ff>s3-access-policy</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138</span><span>      <span style=color:#f92672>Roles</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139</span><span>        - !<span style=color:#ae81ff>Ref TFRole</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140</span><span>      <span style=color:#f92672>PolicyDocument</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141</span><span>        <span style=color:#f92672>Version</span>: <span style=color:#e6db74>&#39;2012-10-17&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142</span><span>        <span style=color:#f92672>Statement</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143</span><span>        - <span style=color:#f92672>Effect</span>: <span style=color:#ae81ff>Allow</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144</span><span>          <span style=color:#f92672>Action</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145</span><span>            - <span style=color:#e6db74>&#39;s3:List*&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146</span><span>            - <span style=color:#e6db74>&#39;s3:GetObject*&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147</span><span>            - <span style=color:#e6db74>&#39;s3:PutObject&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">148</span><span>            - <span style=color:#e6db74>&#39;s3:PutObjectAcl&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">149</span><span>          <span style=color:#f92672>Resource</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">150</span><span>            - <span style=color:#e6db74>&#39;arn:aws:s3:::bucket&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">151</span><span>            - <span style=color:#e6db74>&#39;arn:aws:s3:::bucket/*&#39;</span>
</span></span></code></pre></div><p>As you can see, the template creates -</p><ol><li>An S3 bucket which will be used to save the terraform state</li><li>A Dynamodb table for terraform state locking</li><li>An OIDC provider for Bitbucket pipelines to use</li><li>IAM Role and policies to provide necessary access to Bitbucket pipelines</li><li>The policies <code>CBPolicy</code>, <code>IAMPolicy</code>, <code>S3Policy</code> provide appropriate permissions to create and manage a codebuild project. These will ofcourse vary, depending on what you plan to manage with Terraform.</li><li>For the <code>BBOidc</code> resource, replace the values <code>AUDIENCE</code>, <code>IDENTITY PROVIDER URL</code> and <code>THUMBPRINT</code>. These can be obtained from Bitbucket under Repository settings. Details are <a href=https://support.atlassian.com/bitbucket-cloud/docs/integrate-pipelines-with-resource-servers-using-oidc/>here</a></li></ol><p>Once this template is deployed, we have the necessary basics setup to start setting up the pipeline on Bitbucket. Bear in mind though, this is more of an academic exercise. If you plan to roll this out in production, you should probably look at securing this role further. By defining conditions in the role&rsquo;s IAM trust policy to tie down the scope to a particular repo or workspace, as well as possibly restricting it by IPs.</p><h3 id=step-2---terraform-configs>Step 2 - Terraform Configs<a hidden class=anchor aria-hidden=true href=#step-2---terraform-configs>#</a></h3><p>I will just share the <code>provider</code> block to keep it short, you can build up on this to create any necessary AWS resources. Be sure to modify the Cloudformation stack above for the proper permissions.</p><script src="https://gist.github.com/abiydv/7bdbf542b151b6b2b5a29a643c09eebd.js?file=provider.tf"></script><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tf data-lang=tf><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#75715e># Backend config for remote_state
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#75715e></span><span style=color:#a6e22e>terraform</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  <span style=color:#a6e22e>backend</span> <span style=color:#e6db74>&#34;s3&#34;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#a6e22e>bucket</span>         = <span style=color:#e6db74>&#34;BUCKET_FROM_CFTEMPLATE&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#a6e22e>key</span>            = <span style=color:#e6db74>&#34;DYNAMODB_KEY&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#a6e22e>region</span>         = <span style=color:#e6db74>&#34;REPLACE_WITH_REGION_TO_USE&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#a6e22e>encrypt</span>        = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#a6e22e>dynamodb_table</span> = <span style=color:#e6db74>&#34;DYNAMODB_FROM_CFTEMPLATE&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  <span style=color:#a6e22e>required_providers</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#a6e22e>aws</span> = {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>      <span style=color:#a6e22e>source</span>  = <span style=color:#e6db74>&#34;hashicorp/aws&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>      <span style=color:#a6e22e>version</span> = <span style=color:#e6db74>&#34;~&gt; 3.0&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#75715e># Configure aws provider
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#75715e></span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;aws&#34;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>  <span style=color:#a6e22e>region</span> = <span style=color:#e6db74>&#34;REPLACE_WITH_REGION_TO_USE&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>}
</span></span></code></pre></div><p>You will need to replace <code>BUCKET_FROM_CFTEMPLATE</code>, <code>DYNAMODB_FROM_CFTEMPLATE</code>, <code>DYNAMODB_KEY</code>, <code>REPLACE_WITH_REGION_TO_USE</code>. The Dynamodb and S3 bucket are created in Step 1, just copy over the values from there.</p><h3 id=step-3---configure-bitbucket-pipeline>Step 3 - Configure Bitbucket Pipeline<a hidden class=anchor aria-hidden=true href=#step-3---configure-bitbucket-pipeline>#</a></h3><p>Right, now to the heart of the matter - configuring Bitbucket pipeline. It is fairly simple, you just need to add a file <code>bibucket-pipelines.yml</code> in the same Bitbucket repo as your terraform code. The one I used is included below.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#f92672>image</span>: <span style=color:#ae81ff>hashicorp/terraform:1.0.7</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#f92672>definitions</span>: 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  <span style=color:#f92672>scripts</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    - <span style=color:#f92672>script</span>: <span style=color:#75715e>&amp;aws-context</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        <span style=color:#ae81ff>export AWS_REGION=REPLACE_WITH_REGION_TO_USE;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#ae81ff>export AWS_WEB_IDENTITY_TOKEN_FILE=$(pwd)/web-identity-token;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        <span style=color:#ae81ff>export AWS_ROLE_SESSION_NAME=build-session;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#ae81ff>export AWS_ROLE_ARN=REPLACE_WITH_ROLE_ARN_TO_USE;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#ae81ff>echo $BITBUCKET_STEP_OIDC_TOKEN &gt; $(pwd)/web-identity-token</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    - <span style=color:#f92672>step</span>: <span style=color:#75715e>&amp;validate</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Validate Terraform config</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#f92672>oidc</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>          - <span style=color:#ae81ff>terraform init -backend=false</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>          - <span style=color:#ae81ff>terraform validate</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    - <span style=color:#f92672>step</span>: <span style=color:#75715e>&amp;plan</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Terraform Plan</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#f92672>oidc</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>          - <span style=color:#75715e>*aws-context</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>          - <span style=color:#ae81ff>terraform init</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>          - <span style=color:#ae81ff>terraform plan -input=false -out=tfplan.out</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        <span style=color:#f92672>artifacts</span>: 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>          - <span style=color:#ae81ff>tfplan.out</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    - <span style=color:#f92672>step</span>: <span style=color:#75715e>&amp;apply</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Terraform Apply</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>        <span style=color:#f92672>oidc</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        <span style=color:#f92672>trigger</span>: <span style=color:#ae81ff>manual</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>        <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>          - <span style=color:#75715e>*aws-context</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>          - <span style=color:#ae81ff>terraform init</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>          - <span style=color:#ae81ff>terraform apply -input=false -auto-approve tfplan.out</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#f92672>pipelines</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>  <span style=color:#f92672>branches</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>    <span style=color:#f92672>main</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>      - <span style=color:#f92672>step</span>: <span style=color:#75715e>*validate</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>      - <span style=color:#f92672>step</span>: <span style=color:#75715e>*plan</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>      - <span style=color:#f92672>step</span>: <span style=color:#75715e>*apply</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>    <span style=color:#f92672>default</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>      - <span style=color:#f92672>step</span>: <span style=color:#75715e>*validate</span>
</span></span></code></pre></div><p>There is a lot going on in there, so I&rsquo;ll try to break it down a bit.</p><p>First up are the <code>definitions</code> - Resources here can be resued in your pipeline using yaml anchor. So this is a good place to declare stuff you know you will be calling often. In this case, I have declared a script which sets up the environment variables necessary for the OIDC role flow to work. Yes, you need to attach this to EVERY step which needs access to AWS via the OIDC role.</p><p>Second, notice the flag <code>oidc: true</code> that is applied to all the steps that need access to AWS resources. This possibly tells Bitbucket to kick off some magic in the backend and populate all the environment variables we set up above.</p><p>Third, I use <code>artifacts</code> to pass on the plan output from one step to the next. This is resued when you run the apply step.</p><p>Fourth, I have a flag <code>trigger: manual</code> on the terraform apply step. This ensures the apply step is only triggered after a careful review of the plan step above. But you can always remove it to trigger the apply as soon as plan succeeds.</p><p>And that&rsquo;s it really! Now everytime you commit a change to the repo, you should see a pipeline run triggered.</p><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>I hope this post proves useful to setup a OIDC role based access control for Bitbucket pipelines. There are a plethora of customization options available for them including running the builds on <a href=https://support.atlassian.com/bitbucket-cloud/docs/runners/>self hosted runners</a>. So feel free to go through their docs to find out more, I will include the useful links below.</p><h2>References (3)</h2><ol class=slimlist-ol><li class=slimlist-ol><a aria-label="link to https://support.atlassian.com/bitbucket-cloud/docs/configure-your-pipeline" target=_blank href=https://support.atlassian.com/bitbucket-cloud/docs/configure-your-pipeline>Configure Your Pipeline&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li class=slimlist-ol><a aria-label="link to https://support.atlassian.com/bitbucket-cloud/docs/integrate-pipelines-with-resource-servers-using-oidc" target=_blank href=https://support.atlassian.com/bitbucket-cloud/docs/integrate-pipelines-with-resource-servers-using-oidc>Integrate Pipelines With Resource Servers Using Oidc&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li class=slimlist-ol><a aria-label="link to https://support.atlassian.com/bitbucket-cloud/docs/deploy-on-aws-using-bitbucket-pipelines-openid-connect" target=_blank href=https://support.atlassian.com/bitbucket-cloud/docs/deploy-on-aws-using-bitbucket-pipelines-openid-connect>Deploy on Aws Using Bitbucket Pipelines Openid Connect&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ol></div><footer class=post-footer><hr><div class=align-center><div class=slimlist-entry><h2>Tags</h2></div><ul class=post-tags><div class=slimlist-entry><li class=post-tags><a href=https://abiydv.github.io/tags/bitbucket/>bitbucket</a></li><li class=post-tags><a href=https://abiydv.github.io/tags/pipelines/>pipelines</a></li><li class=post-tags><a href=https://abiydv.github.io/tags/aws/>aws</a></li><li class=post-tags><a href=https://abiydv.github.io/tags/terraform/>terraform</a></li><li class=post-tags><a href=https://abiydv.github.io/tags/cloudformation/>cloudformation</a></li><li class=post-tags><a href=https://abiydv.github.io/tags/cicd/>cicd</a></li></div></ul></div></footer><script src=https://utteranc.es/client.js repo=abiydv/abiydv.github.io issue-term=title label=Comment theme=github-light crossorigin=anonymous async></script><hr><div class=align-left><div class=slimlist-entry><h2>Related</h2></div><ul class=slimlist><li class=slimlist><div class=slimlist-entry><h3 class=slimlist-entry-title><a aria-label="post link to Terraform, multi-account and multi-region workloads" href=https://abiydv.github.io/posts/terraform-multiaccount-multiregion/>Terraform, multi-account and multi-region workloads</a></h3><div class=slimlist-meta>25.5.22 / Posts / 5 min</div></div></li><li class=slimlist><div class=slimlist-entry><h3 class=slimlist-entry-title><a aria-label="post link to S3 Presigned URLs" href=https://abiydv.github.io/posts/s3-presigned-urls/>S3 Presigned URLs</a></h3><div class=slimlist-meta>10.7.21 / Posts / 5 min</div></div></li><li class=slimlist><div class=slimlist-entry><h3 class=slimlist-entry-title><a aria-label="post link to Fastly Geolocation Service" href=https://abiydv.github.io/posts/fastly-geo-service/>Fastly Geolocation Service</a></h3><div class=slimlist-meta>6.3.21 / Posts / 6 min</div></div></li></ul></div></article></main><footer class=footer><span>&copy; 2019-2025 <a href=https://abiydv.github.io/>@abiydv</a> / </span><span>Published 4.4.25 /
</span><span>Thanks <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a>, <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>