<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Elasticsearch Ingest Pipelines | @abiydv</title>
<meta name=keywords content="elasticsearch,serverless,aws,aws-lambda,monitoring"><meta name=description content="Guide to Elasticsearch Ingest Pipelines"><meta name=author content><link rel=canonical href=https://abiydv.github.io/posts/elasticsearch-ingest-pipelines/><link crossorigin=anonymous href=/assets/css/stylesheet.c5edd088d0c984c192170cfbab7d2de030010ee0b7d771bd6bca049dd2332874.css integrity="sha256-xe3QiNDJhMGSFwz7q30t4DABDuC313G9a8oEndIzKHQ=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://abiydv.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://abiydv.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://abiydv.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://abiydv.github.io/apple-touch-icon.png><link rel=mask-icon href=https://abiydv.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://abiydv.github.io/posts/elasticsearch-ingest-pipelines/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Elasticsearch Ingest Pipelines"><meta property="og:description" content="Guide to Elasticsearch Ingest Pipelines"><meta property="og:type" content="article"><meta property="og:url" content="https://abiydv.github.io/posts/elasticsearch-ingest-pipelines/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-09-12T00:00:00+00:00"><meta property="article:modified_time" content="2019-09-12T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Elasticsearch Ingest Pipelines"><meta name=twitter:description content="Guide to Elasticsearch Ingest Pipelines"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://abiydv.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Elasticsearch Ingest Pipelines","item":"https://abiydv.github.io/posts/elasticsearch-ingest-pipelines/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Elasticsearch Ingest Pipelines","name":"Elasticsearch Ingest Pipelines","description":"Guide to Elasticsearch Ingest Pipelines","keywords":["elasticsearch","serverless","aws","aws-lambda","monitoring"],"articleBody":"Introduction Elasticsearch is an open-source search solution which is quite popular for centralzed logs ingestion. It allows logs from various different sources to be available and searchable at a centralized location.\nIngesting data from various sources though, creates a problem. How do you normalize the incoming data, split it into some common fields, add or remove metadata etc? To perform all of this (and more), Logstash is the go-to solution. It can manipulate, transform incoming data before pushing it off to Elasticsearch for indexing.\nKibana is the tool of choice to search and visualize data indexed in Elasticsearch. These 3 together, are often referred as the ELK stack.\nProblem AWS now has a managed Elasticsearch offering which is a fantastic option for small teams with limited capacity to manage a self hosted Elasticsearch solution on EC2/ECS/EKS. There is a downside though. It only offers E_K from the ELK stack. Yes, there is no L (Logstash) out of the box. The only option is to self host a Logstash install - which kind of defeats the purpose of using a managed service.\nSolution Enter Elasticsearch ingest pipelines. These are not a complete replacement of Logstash, but they can do the data transformation part quite easily, if that’s the only thing you use Logstash for. Best part being, they run on the same cluster as Elasticsearch.\nIn my project, logs are being aggregated from a number of different sources - java app logs, httpd logs, systemd logs, external system logs etc. While most of these are ingested using filebeat agents, external logs arriving in S3 are ingested via Lambda.\nUsing ingest pipelines, I can split the data in various fields by applying different grok patterns but indexing them back in the same index. At a high level, this is what the whole setup looks like.\nIngest Pipeline(s) At its core, an ingest pipeline is a series of processors that are executed in order, to process/transform data. In this case, there are multiple ingest pipelines. The main pipeline accepts all incoming data, and based on some condition, will then invoke the sub-pipelines.\nThe some condition here is the value of the field logpattern. This will become more clear as we look at the configuration of each component in this whole setup.\nLet’s start with creating the pipelines first. Then we’ll look at the entrypoints - filebeat and lambda - which read the logs and forward it to the Elasticsearch cluster.\nMain Pipeline Configuration Broadly, all pipelines have the same structure - description and a bunch of processors. In the case of master_pipeline, I have used the following -\ndrop - To prevent the document from getting indexed on some condition. set - To add a new field, value can either be static or derived from other fields. remove - To delete a field from the document before it is indexed. pipeline - Trigger other ingest pipelines for further steps. 1{ 2 \"description\" : \"main pipeline\", 3 \"processors\" : [ 4 { 5 \"drop\" : { 6 \"if\" : \"ctx.message.toLowerCase().contains('some unwanted data')\" 7 } 8 }, 9 { 10 \"set\" : { 11 \"field\" : \"hostname\", 12 \"value\" : \"{{host.name}}\" 13 } 14 }, 15 { 16 \"remove\" : { 17 \"field\" : [ 18 \"host.containerized\", 19 \"host.architecture\", 20 \"host.hostname\", 21 \"host.name\", 22 \"host.os.codename\", 23 ] 24 } 25 }, 26 { 27 \"pipeline\" : { 28 \"if\" : \"ctx.logpattern == 'java_log'\", 29 \"name\" : \"java_log_pipeline\" 30 } 31 }, 32 { 33 \"pipeline\" : { 34 \"if\" : \"ctx.logpattern == 'httpd_log'\", 35 \"name\" : \"httpd_log_pipeline\" 36 } 37 }, 38 { 39 \"pipeline\" : { 40 \"if\" : \"ctx.logpattern == 'system_log'\", 41 \"name\" : \"system_log_pipeline\" 42 } 43 } 44 { 45 \"pipeline\" : { 46 \"if\" : \"ctx.logpattern == 'external_log'\", 47 \"name\" : \"external_log_pipeline\" 48 } 49 } 50 ], 51 \"on_failure\" : [ 52 { 53 \"set\" : { 54 \"field\" : \"Error\", 55 \"value\" : \"{{_ingest.on_failure_message}}\" 56 } 57 } 58 ] 59 } Other pipelines also have the same structure, but different processors. The most important one being the grok processor. It is responsible for splitting the log entry into sub-fields which can then be searched or aggregated. Following is an example for the httpd_logs_pipeline.\n1{ 2 \"description\" : \"httpd logs\", 3 \"processors\" : [ 4 { 5 \"gsub\" : { 6 \"field\" : \"message\", 7 \"pattern\" : \"\\\"\", 8 \"replacement\" : \"\" 9 } 10 }, 11 { 12 \"grok\" : { 13 \"field\" : \"message\", 14 \"patterns\" : [ 15 \"^%{IPV4:ipv4} - %{USER:username} %{HTTPDATE:datetime} %{PROG:method} %{URIPATHPARAM:request_uri} %{EMAILLOCALPART:http_version} %{NUMBER:http_status_code} %{PROG:pid} (%{NOTSPACE:request_by}|-) %{JAVALOGMESSAGE:useragent}$\" 16 ] 17 } 18 }, 19 { 20 \"set\" : { 21 \"field\" : \"details\", 22 \"value\" : \"{{ipv4}} - {{username}} {{method}} {{request_uri}} {{http_version}} {{http_status_code}} {{pid}} {{request_by}} {{useragent}}\" 23 } 24 }, 25 { 26 \"date\" : { 27 \"field\" : \"datetime\", 28 \"formats\" : [ 29 \"dd/MMM/yyyy:HH:mm:ss Z\", 30 \"ISO8601\" 31 ], 32 \"timezone\" : \"Europe/London\" 33 } 34 }, 35 { 36 \"uppercase\" : { 37 \"field\" : \"severity\", 38 \"on_failure\" : [ 39 { 40 \"set\" : { 41 \"field\" : \"severity\", 42 \"value\" : \"INFO\" 43 } 44 } 45 ] 46 } 47 }, 48 { 49 \"remove\" : { 50 \"field\" : \"datetime\" 51 } 52 } 53 ] 54} Elasticsearch Configuration Once ingest pipeline jsons are ready, it’s quite simple to add these to the Elasticsearch cluster. Following command adds a new pipeline\n1$ curl -X POST https://elasticsearch.example.com/_ingest/pipeline/pipeline_name -d pipeline_definition.json Following command diplays currently configured pipelines on the Elasticsearch cluster.\n1$ curl https://elasticsearch.example.com/_ingest/pipeline Filebeat Configuration The source of logs are modified next to use the configured ingest pipelines.\nShown here are only a subset of all the propeties that might be required. Notice the field logpattern under fields - this ensures the new field is appended to every log entry. Further down, in the Elasticsearch section, index name and the pipeline name are specified.\n1- type: log 2 enabled: true 3 paths: 4 - /opt/app/server/logs/stdout.log 5 fields_under_root: true 6 fields: 7 logpattern: \"java_logs\" 8 role: \"java\" 9 multiline.pattern: ^\\d{4}-\\d{1,2}-\\d{1,2} 10 multiline.negate: true 11 multiline.match: after 12# Elasticsearch 13output.elasticsearch: 14 hosts: [ \"https://elasticsearch.example.com:443\" ] 15 index: \"logs-%{+yyyy.MM.dd}\" 16 pipeline: main_pipeline Lambda Configuration Second input source is Lambda, which uses the Elasticsearch bulk API to index the logs pushed to S3. In this case, similar to filebeat, a new field logpattern is added to each record. After that, during indexing, a new querystring with the pipeline name is added.\nPOST /index/_bulk?pipeline=master_pipeline Conclusion That’s it!\nNow all incoming data gets transformed first by a combnation of ingest pipelines, before getting indexed in Elasticsearch. 👏\nReferences (5) Pipeline Ingest Processors Ingest Apis Filebeat Reference Yml Docs Bulk ","wordCount":"1115","inLanguage":"en","datePublished":"2019-09-12T00:00:00Z","dateModified":"2019-09-12T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://abiydv.github.io/posts/elasticsearch-ingest-pipelines/"},"publisher":{"@type":"Organization","name":"@abiydv","logo":{"@type":"ImageObject","url":"https://abiydv.github.io/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://abiydv.github.io/ accesskey=h title="@abiydv (Alt + H)">@abiydv</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://abiydv.github.io/ title=Home><span>Home</span></a></li><li><a href=https://abiydv.github.io/about/ title=About><span>About</span></a></li><li><a href=https://abiydv.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://abiydv.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://abiydv.github.io/notes/ title=Notes><span>Notes</span></a></li><li><a href=https://abiydv.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://abiydv.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://abiydv.github.io/posts/>Posts</a></div><h1 class=post-title>Elasticsearch Ingest Pipelines</h1><div class=post-description>Guide to Elasticsearch Ingest Pipelines</div><div class=post-meta>12.9.19 / Posts / 6 min</div></header><div class=post-content><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p><a href=https://www.elastic.co/elasticsearch>Elasticsearch</a> is an open-source search solution which is quite popular for centralzed logs ingestion. It allows logs from various different sources to be available and searchable at a centralized location.</p><p>Ingesting data from various sources though, creates a problem. How do you normalize the incoming data, split it into some common fields, add or remove metadata etc? To perform all of this (and more), <a href=https://www.elastic.co/logstash>Logstash</a> is the go-to solution. It can manipulate, transform incoming data before pushing it off to Elasticsearch for indexing.</p><p><a href=https://www.elastic.co/kibana>Kibana</a> is the tool of choice to search and visualize data indexed in Elasticsearch. These 3 together, are often referred as the <strong>ELK</strong> stack.</p><h2 id=problem>Problem<a hidden class=anchor aria-hidden=true href=#problem>#</a></h2><p>AWS now has a <a href=https://aws.amazon.com/elasticsearch-service/>managed Elasticsearch offering</a> which is a fantastic option for small teams with limited capacity to manage a self hosted Elasticsearch solution on EC2/ECS/EKS. There is a downside though. It only offers E_K from the ELK stack. Yes, there is no <strong>L</strong> (Logstash) out of the box. The only option is to self host a Logstash install - which kind of defeats the purpose of using a managed service.</p><h2 id=solution>Solution<a hidden class=anchor aria-hidden=true href=#solution>#</a></h2><p>Enter Elasticsearch ingest pipelines. These are not a complete replacement of Logstash, but they can do the data transformation part quite easily, if that&rsquo;s the only thing you use Logstash for. Best part being, they run on the same cluster as Elasticsearch.</p><p>In my project, logs are being aggregated from a number of different sources - java app logs, httpd logs, systemd logs, external system logs etc. While most of these are ingested using filebeat agents, external logs arriving in S3 are ingested via Lambda.</p><p>Using ingest pipelines, I can split the data in various fields by applying different <a href=https://www.elastic.co/guide/en/logstash/current/plugins-filters-grok.html>grok patterns</a> but indexing them back in the same index. At a high level, this is what the whole setup looks like.</p><p><img loading=lazy src=../../images/es-pipeline.jpg alt=image></p><h2 id=ingest-pipelines>Ingest Pipeline(s)<a hidden class=anchor aria-hidden=true href=#ingest-pipelines>#</a></h2><p>At its core, an ingest pipeline is a series of processors that are executed in order, to process/transform data. In this case, there are multiple ingest pipelines. The main pipeline accepts all incoming data, and based on <em>some</em> condition, will then invoke the sub-pipelines.</p><p>The <em>some</em> condition here is the value of the field <code>logpattern</code>. This will become more clear as we look at the configuration of each component in this whole setup.</p><p>Let&rsquo;s start with creating the pipelines first. Then we&rsquo;ll look at the entrypoints - filebeat and lambda - which read the logs and forward it to the Elasticsearch cluster.</p><h3 id=main-pipeline-configuration>Main Pipeline Configuration<a hidden class=anchor aria-hidden=true href=#main-pipeline-configuration>#</a></h3><p>Broadly, all pipelines have the same structure - description and a bunch of <a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/ingest-processors.html>processors</a>. In the case of master_pipeline, I have used the following -</p><ul><li><code>drop</code> - To prevent the document from getting indexed on some condition.</li><li><code>set</code> - To add a new field, value can either be static or derived from other fields.</li><li><code>remove</code> - To delete a field from the document before it is indexed.</li><li><code>pipeline</code> - Trigger other ingest pipelines for further steps.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#f92672>&#34;description&#34;</span> : <span style=color:#e6db74>&#34;main pipeline&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#f92672>&#34;processors&#34;</span> : [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>      {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        <span style=color:#f92672>&#34;drop&#34;</span> : {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>          <span style=color:#f92672>&#34;if&#34;</span> : <span style=color:#e6db74>&#34;ctx.message.toLowerCase().contains(&#39;some unwanted data&#39;)&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>      },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>      {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        <span style=color:#f92672>&#34;set&#34;</span> : {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>          <span style=color:#f92672>&#34;field&#34;</span> : <span style=color:#e6db74>&#34;hostname&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#e6db74>&#34;{{host.name}}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>      },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>      {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#f92672>&#34;remove&#34;</span> : {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>          <span style=color:#f92672>&#34;field&#34;</span> : [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>            <span style=color:#e6db74>&#34;host.containerized&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>            <span style=color:#e6db74>&#34;host.architecture&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>            <span style=color:#e6db74>&#34;host.hostname&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>            <span style=color:#e6db74>&#34;host.name&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>            <span style=color:#e6db74>&#34;host.os.codename&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>          ]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>      },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>      {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>        <span style=color:#f92672>&#34;pipeline&#34;</span> : {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>          <span style=color:#f92672>&#34;if&#34;</span> : <span style=color:#e6db74>&#34;ctx.logpattern == &#39;java_log&#39;&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>          <span style=color:#f92672>&#34;name&#34;</span> : <span style=color:#e6db74>&#34;java_log_pipeline&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>      },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>      {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>        <span style=color:#f92672>&#34;pipeline&#34;</span> : {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>          <span style=color:#f92672>&#34;if&#34;</span> : <span style=color:#e6db74>&#34;ctx.logpattern == &#39;httpd_log&#39;&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>          <span style=color:#f92672>&#34;name&#34;</span> : <span style=color:#e6db74>&#34;httpd_log_pipeline&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>      },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>      {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>        <span style=color:#f92672>&#34;pipeline&#34;</span> : {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>          <span style=color:#f92672>&#34;if&#34;</span> : <span style=color:#e6db74>&#34;ctx.logpattern == &#39;system_log&#39;&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>          <span style=color:#f92672>&#34;name&#34;</span> : <span style=color:#e6db74>&#34;system_log_pipeline&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>      {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>        <span style=color:#f92672>&#34;pipeline&#34;</span> : {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>          <span style=color:#f92672>&#34;if&#34;</span> : <span style=color:#e6db74>&#34;ctx.logpattern == &#39;external_log&#39;&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>          <span style=color:#f92672>&#34;name&#34;</span> : <span style=color:#e6db74>&#34;external_log_pipeline&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>    ],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>    <span style=color:#f92672>&#34;on_failure&#34;</span> : [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>      {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>        <span style=color:#f92672>&#34;set&#34;</span> : {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>          <span style=color:#f92672>&#34;field&#34;</span> : <span style=color:#e6db74>&#34;Error&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#e6db74>&#34;{{_ingest.on_failure_message}}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>    ]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>  }
</span></span></code></pre></div><p>Other pipelines also have the same structure, but different processors. The most important one being the <a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/grok-processor.html>grok processor</a>. It is responsible for splitting the log entry into sub-fields which can then be searched or aggregated. Following is an example for the <code>httpd_logs_pipeline</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#f92672>&#34;description&#34;</span> : <span style=color:#e6db74>&#34;httpd logs&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#f92672>&#34;processors&#34;</span> : [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>      {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        <span style=color:#f92672>&#34;gsub&#34;</span> : {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>          <span style=color:#f92672>&#34;field&#34;</span> : <span style=color:#e6db74>&#34;message&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>          <span style=color:#f92672>&#34;pattern&#34;</span> : <span style=color:#e6db74>&#34;\&#34;&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>          <span style=color:#f92672>&#34;replacement&#34;</span> : <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>      },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>      {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#f92672>&#34;grok&#34;</span> : {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>          <span style=color:#f92672>&#34;field&#34;</span> : <span style=color:#e6db74>&#34;message&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>          <span style=color:#f92672>&#34;patterns&#34;</span> : [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>            <span style=color:#e6db74>&#34;^%{IPV4:ipv4} - %{USER:username} %{HTTPDATE:datetime} %{PROG:method} %{URIPATHPARAM:request_uri} %{EMAILLOCALPART:http_version} %{NUMBER:http_status_code} %{PROG:pid} (%{NOTSPACE:request_by}|-) %{JAVALOGMESSAGE:useragent}$&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>          ]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>      },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>      {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        <span style=color:#f92672>&#34;set&#34;</span> : {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>          <span style=color:#f92672>&#34;field&#34;</span> : <span style=color:#e6db74>&#34;details&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#e6db74>&#34;{{ipv4}} - {{username}} {{method}} {{request_uri}} {{http_version}} {{http_status_code}} {{pid}} {{request_by}} {{useragent}}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>      },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>      {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        <span style=color:#f92672>&#34;date&#34;</span> : {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>          <span style=color:#f92672>&#34;field&#34;</span> : <span style=color:#e6db74>&#34;datetime&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>          <span style=color:#f92672>&#34;formats&#34;</span> : [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>            <span style=color:#e6db74>&#34;dd/MMM/yyyy:HH:mm:ss Z&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>            <span style=color:#e6db74>&#34;ISO8601&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>          ],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>          <span style=color:#f92672>&#34;timezone&#34;</span> : <span style=color:#e6db74>&#34;Europe/London&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>      },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>      {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>        <span style=color:#f92672>&#34;uppercase&#34;</span> : {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>          <span style=color:#f92672>&#34;field&#34;</span> : <span style=color:#e6db74>&#34;severity&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>          <span style=color:#f92672>&#34;on_failure&#34;</span> : [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>            {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>              <span style=color:#f92672>&#34;set&#34;</span> : {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>                <span style=color:#f92672>&#34;field&#34;</span> : <span style=color:#e6db74>&#34;severity&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>                <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#e6db74>&#34;INFO&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>              }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>          ]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>      },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>      {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>        <span style=color:#f92672>&#34;remove&#34;</span> : {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>          <span style=color:#f92672>&#34;field&#34;</span> : <span style=color:#e6db74>&#34;datetime&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>    ]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>}
</span></span></code></pre></div><h3 id=elasticsearch-configuration>Elasticsearch Configuration<a hidden class=anchor aria-hidden=true href=#elasticsearch-configuration>#</a></h3><p>Once ingest pipeline jsons are ready, it&rsquo;s quite simple to add these to the Elasticsearch cluster. Following command adds a new pipeline</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ curl -X POST https://elasticsearch.example.com/_ingest/pipeline/pipeline_name -d pipeline_definition.json
</span></span></code></pre></div><p>Following command diplays currently configured pipelines on the Elasticsearch cluster.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ curl https://elasticsearch.example.com/_ingest/pipeline
</span></span></code></pre></div><h3 id=filebeat-configuration>Filebeat Configuration<a hidden class=anchor aria-hidden=true href=#filebeat-configuration>#</a></h3><p>The source of logs are modified next to use the configured ingest pipelines.</p><p>Shown here are only a subset of all the propeties that might be required. Notice the field <code>logpattern</code> under fields - this ensures the new field is appended to every log entry. Further down, in the Elasticsearch section, index name and the pipeline name are specified.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>- <span style=color:#f92672>type</span>: <span style=color:#ae81ff>log</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  <span style=color:#f92672>paths</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    - <span style=color:#ae81ff>/opt/app/server/logs/stdout.log</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  <span style=color:#f92672>fields_under_root</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>  <span style=color:#f92672>fields</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#f92672>logpattern</span>: <span style=color:#e6db74>&#34;java_logs&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#f92672>role</span>: <span style=color:#e6db74>&#34;java&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  <span style=color:#f92672>multiline.pattern</span>: <span style=color:#ae81ff>^\d{4}-\d{1,2}-\d{1,2}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  <span style=color:#f92672>multiline.negate</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  <span style=color:#f92672>multiline.match</span>: <span style=color:#ae81ff>after</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#75715e># Elasticsearch</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#f92672>output.elasticsearch</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>  <span style=color:#f92672>hosts</span>: [ <span style=color:#e6db74>&#34;https://elasticsearch.example.com:443&#34;</span> ]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>  <span style=color:#f92672>index</span>: <span style=color:#e6db74>&#34;logs-%{+yyyy.MM.dd}&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>  <span style=color:#f92672>pipeline</span>: <span style=color:#ae81ff>main_pipeline</span>
</span></span></code></pre></div><h3 id=lambda-configuration>Lambda Configuration<a hidden class=anchor aria-hidden=true href=#lambda-configuration>#</a></h3><p>Second input source is Lambda, which uses the Elasticsearch bulk API to index the logs pushed to S3. In this case, similar to filebeat, a new field <code>logpattern</code> is added to each record. After that, during indexing, a new querystring with the pipeline name is added.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>POST /index/_bulk?pipeline<span style=color:#f92672>=</span>master_pipeline
</span></span></code></pre></div><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>That&rsquo;s it!</p><p>Now all incoming data gets transformed first by a combnation of ingest pipelines, before getting indexed in Elasticsearch. &#x1f44f;</p><h2>References (5)</h2><ol class=slimlist-ol><li class=slimlist-ol><a aria-label="link to * https://www.elastic.co/guide/en/elasticsearch/reference/current/pipeline.html" target=_blank href=#ZgotmplZ>Pipeline&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li class=slimlist-ol><a aria-label="link to * https://www.elastic.co/guide/en/elasticsearch/reference/current/ingest-processors.html" target=_blank href=#ZgotmplZ>Ingest Processors&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li class=slimlist-ol><a aria-label="link to * https://www.elastic.co/guide/en/elasticsearch/reference/current/ingest-apis.html" target=_blank href=#ZgotmplZ>Ingest Apis&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li class=slimlist-ol><a aria-label="link to * https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-reference-yml.html" target=_blank href=#ZgotmplZ>Filebeat Reference Yml&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li class=slimlist-ol><a aria-label="link to * https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-bulk.html" target=_blank href=#ZgotmplZ>Docs Bulk&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ol></div><footer class=post-footer><hr><div class=align-center><div class=slimlist-entry><h2>Tags</h2></div><ul class=post-tags><div class=slimlist-entry><li class=post-tags><a href=https://abiydv.github.io/tags/elasticsearch/>elasticsearch</a></li><li class=post-tags><a href=https://abiydv.github.io/tags/serverless/>serverless</a></li><li class=post-tags><a href=https://abiydv.github.io/tags/aws/>aws</a></li><li class=post-tags><a href=https://abiydv.github.io/tags/aws-lambda/>aws-lambda</a></li><li class=post-tags><a href=https://abiydv.github.io/tags/monitoring/>monitoring</a></li></div></ul></div></footer><script src=https://utteranc.es/client.js repo=abiydv/abiydv.github.io issue-term=title label=Comment theme=github-light crossorigin=anonymous async></script><hr><div class=align-left><div class=slimlist-entry><h2>Related</h2></div><ul class=slimlist><li class=slimlist><div class=slimlist-entry><h3 class=slimlist-entry-title><a aria-label="post link to Index Logs to Elasticsearch" href=https://abiydv.github.io/posts/index-elasticsearch/>Index Logs to Elasticsearch</a></h3><div class=slimlist-meta>30.12.20 / Posts / 3 min</div></div></li><li class=slimlist><div class=slimlist-entry><h3 class=slimlist-entry-title><a aria-label="post link to Adobe IO and Cloud Manager API" href=https://abiydv.github.io/posts/adobe-io-cloudmanager-api/>Adobe IO and Cloud Manager API</a></h3><div class=slimlist-meta>9.9.20 / Posts / 5 min</div></div></li><li class=slimlist><div class=slimlist-entry><h3 class=slimlist-entry-title><a aria-label="post link to Service Control Policies and BDD" href=https://abiydv.github.io/posts/aws-scp-test-bdd/>Service Control Policies and BDD</a></h3><div class=slimlist-meta>28.6.24 / Posts / 7 min</div></div></li></ul></div></article></main><footer class=footer><span>&copy; 2019-2025 <a href=https://abiydv.github.io/>@abiydv</a> / </span><span>Published 4.4.25 /
</span><span>Thanks <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a>, <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>