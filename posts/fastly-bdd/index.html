<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Fastly BDD | @abiydv</title>
<meta name=keywords content="fastly,bdd,python,behave"><meta name=description content="Implement BDD for Fastly"><meta name=author content><link rel=canonical href=https://abiydv.github.io/posts/fastly-bdd/><link crossorigin=anonymous href=/assets/css/stylesheet.c5edd088d0c984c192170cfbab7d2de030010ee0b7d771bd6bca049dd2332874.css integrity="sha256-xe3QiNDJhMGSFwz7q30t4DABDuC313G9a8oEndIzKHQ=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://abiydv.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://abiydv.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://abiydv.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://abiydv.github.io/apple-touch-icon.png><link rel=mask-icon href=https://abiydv.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://abiydv.github.io/posts/fastly-bdd/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Fastly BDD"><meta property="og:description" content="Implement BDD for Fastly"><meta property="og:type" content="article"><meta property="og:url" content="https://abiydv.github.io/posts/fastly-bdd/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-09-01T00:00:00+00:00"><meta property="article:modified_time" content="2020-09-01T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Fastly BDD"><meta name=twitter:description content="Implement BDD for Fastly"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://abiydv.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Fastly BDD","item":"https://abiydv.github.io/posts/fastly-bdd/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Fastly BDD","name":"Fastly BDD","description":"Implement BDD for Fastly","keywords":["fastly","bdd","python","behave"],"articleBody":"Introduction Fastly is a popular CDN based on the open-source Varnish. Since it supports VCL, a lot of custom “logic” to handle incoming requests can be added, right at the edge. This improves the user experience as well as reduces the overhead on origin servers.\nLet’s take an example of redirects. Traditionally, they are applied on webservers and often involve not-so-straightforward syntax for complex rules (multiple checks for various headers, cookies, referrers, urls etc.). All of these are fairly straight forward to achieve in the VCL. Thanks to a lot of customization by Fastly on default VCL, you even have various functions OOTB for use. It makes redirects one of the easiest to offload to Fastly edge. This is what we will look at in this post.\nProblem As the rules begin to increase on edge, you need to make changes reliably and also need to test before pushing them off to the live environment. You can create multiple services and deploy changes first on a lower environment, test it and then promote to live. As for automating these tests, you can use anything - even a simple curl command (have covered some of it here)\nWhile curl maybe fine to test a few redirects, it’s not ideal if you want to run through hundreds of them, and inspect various different sections of the response. A lot of plumbing would be needed in shell to make it work. Ideally, we need programatic control and constructs.\nSolution Enter behave. It is a BDD1 framework which uses tests written in a natural language style, backed up by Python code.\nThe tests can easily be executed in any CI/CD pipeline as an initial step of deploying a live service. The overall flow can be as follows with AWS Codepipeline and Codebuild - Any commits on github triggers the AWS Codepipeline. First step in the pipeline deploys a test service with the same vcl. Second step runs the behave tests against this test service and destroy the temporary service afterwards. If the tests are successful, the pipeline then runs a tarraform plan against the live service. Waits for a manual approval. A member of the team can review the plan output and approve it. After approval, it deploys the new vcl to the live service. I will cover the Fastly CI/CD in detail in a separate post later.\nLet’s look at an example now.\nFeature Test Cases This defines the functionality that we need to implement and can be written by someone from the business, QA or PM. I am going to use the following structure and layout for this project.\n1+--tests/ 2 +--features/ 3 | +-- steps/ 4 | | +-- steps.py 5 | +-- redirect.feature Consider the first test. It has a feature redirect and within this, there are 2 scenarios. One, to test when actual users hit the site. Second, to test when some crawlers hit the site.\n1Feature: redirect 2 3 Scenario: 4 Given I am a human 5 And I visit https://fastly-bdd-example.com.global.prod.fastly.net/status/200 6 Then Response is redirect 7 And Response reason is REDIRECT 8 And Status code is 302 9 And Redirected url is https://fastly-bdd-example.com/gateway 10 11 Scenario: 12 Given I am a googlebot 13 And I visit https://fastly-bdd-example.com.global.prod.fastly.net/status/200 14 Then Status code is 200 15 And Response reason is OK VCL Now that we have the feature described above, we need to implement this using VCLs. We are going to use vcl snippets which are quicker to setup and use. These can be deployed by the CI/CD pipeline or if you are just testing, from the Fastly console as well.\nrecv vcl snippet\n1if (req.http.User-Agent ~ \"googlebot\"){ 2 return (lookup); 3} 4 5if (req.url ~ \"^/status/200\") { 6 error 902; 7} error vcl snippet\n1if (obj.status == 902) { 2 set obj.status = 302; 3 set obj.response = \"REDIRECT\"; 4 set obj.http.Location = \"https://\" req.http.host \"/gateway\"; 5 return (deliver); 6} Step Files The backend code for running the test is implemented in the file steps.py. You can split this across different files as your tests grow.\n1from behave import * 2import requests 3 4@given(u'I am a {useragent}') 5def step_impl(context,useragent): 6 if \"bot\" in useragent: 7 context.useragent = useragent 8 else: 9 context.useragent = \"pybehave\" 10 11@given(u'I visit {url}') 12def step_impl(context,url): 13 headers = {'User-Agent': context.useragent} 14 context.resp = requests.get(url, headers=headers, allow_redirects=False, verify=False ) 15 print(\"response_headers :\"+str(context.resp.headers)) 16 17@then(u'Response is redirect') 18def step_impl(context): 19 assert context.resp.is_redirect 20 21@then(u'Response reason is {resp_reason}') 22def step_impl(context,resp_reason): 23 print(\"response_reason : \"+context.resp.reason) 24 assert context.resp.reason == resp_reason 25 26@then(u'Status code is {resp_status}') 27def step_impl(context,resp_status): 28 print(\"response_status : \"+str(context.resp.status_code)) 29 assert context.resp.status_code == int(resp_status) 30 31@then(u'Redirected url is {resp_url}') 32def step_impl(context,resp_url): 33 print(\"response_url : \"+context.resp.headers['Location']) 34 assert context.resp.headers['Location'] == resp_url Executing Tests Once you have the above files ready in your project, it is very simple to run the tests. You can use a lot of command line options as per your need. These are described in detail here\n1$ behave 2. 3. 41 feature passed, 0 failed, 0 skipped 51 scenario passed, 0 failed, 0 skipped 66 steps passed, 0 failed, 0 skipped, 0 undefined 7Took 0m0.051s To generate test reports in the junit format use the --junit command-line option. The so generated reports can then be used by any existing junit visualization frameworks you have, to create visualizations.\nConclusion Apart from the obvious benefits of BDD, this workflow ensures issues are caught early and the deployments are error free. A side benefit of deploying it via a CI/CD pipeline is that it also syntax checks the actual VCL snippets before they make it to the live service. Since Fastly’s vcl implementation is quite different from open source Varnish - it is near impossible to syntax check quickly using a varnish container.\nNote: Code mentioned above is here References (2) Behave About Vcl Snippets BDD or Behavior-driven development is an agile software development technique that encourages collaboration between developers, QA and non-technical or business participants in a software project ↩︎\n","wordCount":"995","inLanguage":"en","datePublished":"2020-09-01T00:00:00Z","dateModified":"2020-09-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://abiydv.github.io/posts/fastly-bdd/"},"publisher":{"@type":"Organization","name":"@abiydv","logo":{"@type":"ImageObject","url":"https://abiydv.github.io/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://abiydv.github.io/ accesskey=h title="@abiydv (Alt + H)">@abiydv</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://abiydv.github.io/ title=Home><span>Home</span></a></li><li><a href=https://abiydv.github.io/about/ title=About><span>About</span></a></li><li><a href=https://abiydv.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://abiydv.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://abiydv.github.io/notes/ title=Notes><span>Notes</span></a></li><li><a href=https://abiydv.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://abiydv.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://abiydv.github.io/posts/>Posts</a></div><h1 class=post-title>Fastly BDD</h1><div class=post-description>Implement BDD for Fastly</div><div class=post-meta>1.9.20 / Posts / 5 min</div></header><div class=post-content><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p><a href=https://www.fastly.com/why-fastly>Fastly</a> is a popular CDN based on the open-source <a href=https://varnish-cache.org/intro/index.html#intro>Varnish</a>. Since it supports <a href=https://varnish-cache.org/docs/2.1/reference/vcl.html>VCL</a>, a lot of custom &ldquo;logic&rdquo; to handle incoming requests can be added, right at the edge. This improves the user experience as well as reduces the overhead on origin servers.</p><p>Let&rsquo;s take an example of redirects. Traditionally, they are applied on webservers and often involve not-so-straightforward syntax for complex rules (multiple checks for various headers, cookies, referrers, urls etc.). All of these are fairly straight forward to achieve in the VCL. Thanks to a lot of customization by Fastly on default VCL, you even have various functions OOTB for use. It makes redirects one of the easiest to offload to Fastly edge. This is what we will look at in this post.</p><h2 id=problem>Problem<a hidden class=anchor aria-hidden=true href=#problem>#</a></h2><p>As the rules begin to increase on edge, you need to make changes reliably and also need to test before pushing them off to the live environment. You can create multiple services and deploy changes first on a lower environment, test it and then promote to live. As for automating these tests, you can use anything - even a simple curl command (have covered some of it <a href=/posts/curl-cheatsheet/>here</a>)</p><p>While curl maybe fine to test a few redirects, it&rsquo;s not ideal if you want to run through hundreds of them, and inspect various different sections of the response. A lot of plumbing would be needed in shell to make it work. Ideally, we need programatic control and constructs.</p><h2 id=solution>Solution<a hidden class=anchor aria-hidden=true href=#solution>#</a></h2><p>Enter <a href=https://behave.readthedocs.io/en/latest/>behave</a>. It is a BDD<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> framework which uses tests written in a natural language style, backed up by Python code.</p><p>The tests can easily be executed in any CI/CD pipeline as an initial step of deploying a live service. The overall flow can be as follows with AWS Codepipeline and Codebuild -
<img loading=lazy src=../../images/fastly-bdd.jpg alt=image></p><ol><li>Any commits on github triggers the AWS Codepipeline.</li><li>First step in the pipeline deploys a test service with the same vcl.</li><li>Second step runs the behave tests against this test service and destroy the temporary service afterwards.</li><li>If the tests are successful, the pipeline then runs a tarraform plan against the live service.</li><li>Waits for a manual approval. A member of the team can review the plan output and approve it.</li><li>After approval, it deploys the new vcl to the live service.</li></ol><p>I will cover the Fastly CI/CD in detail in a separate post later.</p><p>Let&rsquo;s look at an example now.</p><h3 id=feature-test-cases>Feature Test Cases<a hidden class=anchor aria-hidden=true href=#feature-test-cases>#</a></h3><p>This defines the functionality that we need to implement and can be written by someone from the business, QA or PM. I am going to use the following structure and layout for this project.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>+--tests/
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    +--features/
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    |    +-- steps/
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    |    |    +-- steps.py
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    |    +-- redirect.feature
</span></span></code></pre></div><p>Consider the first test. It has a <em>feature</em> redirect and within this, there are 2 <em>scenarios</em>. One, to test when actual users hit the site. Second, to test when some crawlers hit the site.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gherkin data-lang=gherkin><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>Feature:</span><span style=color:#a6e22e> redirect
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#a6e22e>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#a6e22e>  </span><span style=color:#66d9ef>Scenario:</span><span style=color:#a6e22e> 
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#a6e22e></span><span style=color:#66d9ef>    Given </span><span style=color:#a6e22e>I am a human
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#a6e22e>    </span><span style=color:#66d9ef>And </span><span style=color:#a6e22e>I visit https://fastly-bdd-example.com.global.prod.fastly.net/status/</span><span style=color:#e6db74>200</span><span style=color:#a6e22e>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#a6e22e>    </span><span style=color:#66d9ef>Then </span><span style=color:#a6e22e>Response is redirect
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#a6e22e>    </span><span style=color:#66d9ef>And </span><span style=color:#a6e22e>Response reason is REDIRECT
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#a6e22e>    </span><span style=color:#66d9ef>And </span><span style=color:#a6e22e>Status code is </span><span style=color:#e6db74>302</span><span style=color:#a6e22e>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#a6e22e>    </span><span style=color:#66d9ef>And </span><span style=color:#a6e22e>Redirected url is https://fastly-bdd-example.com/gateway
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#a6e22e>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#a6e22e>  </span><span style=color:#66d9ef>Scenario:</span><span style=color:#a6e22e> 
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#a6e22e></span><span style=color:#66d9ef>    Given </span><span style=color:#a6e22e>I am a googlebot
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#a6e22e>    </span><span style=color:#66d9ef>And </span><span style=color:#a6e22e>I visit https://fastly-bdd-example.com.global.prod.fastly.net/status/</span><span style=color:#e6db74>200</span><span style=color:#a6e22e>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#a6e22e>    </span><span style=color:#66d9ef>Then </span><span style=color:#a6e22e>Status code is </span><span style=color:#e6db74>200</span><span style=color:#a6e22e>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#a6e22e>    </span><span style=color:#66d9ef>And </span><span style=color:#a6e22e>Response reason is OK
</span></span></span></code></pre></div><h3 id=vcl>VCL<a hidden class=anchor aria-hidden=true href=#vcl>#</a></h3><p>Now that we have the feature described above, we need to implement this using VCLs. We are going to use <a href=https://docs.fastly.com/en/guides/about-vcl-snippets>vcl snippets</a> which are quicker to setup and use. These can be deployed by the CI/CD pipeline or if you are just testing, from the Fastly console as well.</p><p><em>recv vcl snippet</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>req.http.User-Agent ~ <span style=color:#e6db74>&#34;googlebot&#34;</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>lookup<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>req.url ~ <span style=color:#e6db74>&#34;^/status/200&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    error 902;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><em>error vcl snippet</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>obj.status <span style=color:#f92672>==</span> 902<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    set obj.status <span style=color:#f92672>=</span> 302;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    set obj.response <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;REDIRECT&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    set obj.http.Location <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://&#34;</span> req.http.host <span style=color:#e6db74>&#34;/gateway&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>deliver<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=step-files>Step Files<a hidden class=anchor aria-hidden=true href=#step-files>#</a></h3><p>The backend code for running the test is implemented in the file <code>steps.py</code>. You can split this across different files as your tests grow.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#f92672>from</span> behave <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#a6e22e>@given</span>(<span style=color:#e6db74>u</span><span style=color:#e6db74>&#39;I am a </span><span style=color:#e6db74>{useragent}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>step_impl</span>(context,useragent):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#34;bot&#34;</span> <span style=color:#f92672>in</span> useragent:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        context<span style=color:#f92672>.</span>useragent <span style=color:#f92672>=</span> useragent 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        context<span style=color:#f92672>.</span>useragent <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;pybehave&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#a6e22e>@given</span>(<span style=color:#e6db74>u</span><span style=color:#e6db74>&#39;I visit </span><span style=color:#e6db74>{url}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>step_impl</span>(context,url):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    headers <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#39;User-Agent&#39;</span>: context<span style=color:#f92672>.</span>useragent}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    context<span style=color:#f92672>.</span>resp <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(url, headers<span style=color:#f92672>=</span>headers, allow_redirects<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>, verify<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span> )
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    print(<span style=color:#e6db74>&#34;response_headers :&#34;</span><span style=color:#f92672>+</span>str(context<span style=color:#f92672>.</span>resp<span style=color:#f92672>.</span>headers))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#a6e22e>@then</span>(<span style=color:#e6db74>u</span><span style=color:#e6db74>&#39;Response is redirect&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>step_impl</span>(context):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#66d9ef>assert</span> context<span style=color:#f92672>.</span>resp<span style=color:#f92672>.</span>is_redirect
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#a6e22e>@then</span>(<span style=color:#e6db74>u</span><span style=color:#e6db74>&#39;Response reason is </span><span style=color:#e6db74>{resp_reason}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>step_impl</span>(context,resp_reason):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    print(<span style=color:#e6db74>&#34;response_reason : &#34;</span><span style=color:#f92672>+</span>context<span style=color:#f92672>.</span>resp<span style=color:#f92672>.</span>reason)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    <span style=color:#66d9ef>assert</span> context<span style=color:#f92672>.</span>resp<span style=color:#f92672>.</span>reason <span style=color:#f92672>==</span> resp_reason
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#a6e22e>@then</span>(<span style=color:#e6db74>u</span><span style=color:#e6db74>&#39;Status code is </span><span style=color:#e6db74>{resp_status}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>step_impl</span>(context,resp_status):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    print(<span style=color:#e6db74>&#34;response_status : &#34;</span><span style=color:#f92672>+</span>str(context<span style=color:#f92672>.</span>resp<span style=color:#f92672>.</span>status_code))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>    <span style=color:#66d9ef>assert</span> context<span style=color:#f92672>.</span>resp<span style=color:#f92672>.</span>status_code <span style=color:#f92672>==</span> int(resp_status)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#a6e22e>@then</span>(<span style=color:#e6db74>u</span><span style=color:#e6db74>&#39;Redirected url is </span><span style=color:#e6db74>{resp_url}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>step_impl</span>(context,resp_url):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>    print(<span style=color:#e6db74>&#34;response_url : &#34;</span><span style=color:#f92672>+</span>context<span style=color:#f92672>.</span>resp<span style=color:#f92672>.</span>headers[<span style=color:#e6db74>&#39;Location&#39;</span>])
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    <span style=color:#66d9ef>assert</span> context<span style=color:#f92672>.</span>resp<span style=color:#f92672>.</span>headers[<span style=color:#e6db74>&#39;Location&#39;</span>] <span style=color:#f92672>==</span> resp_url
</span></span></code></pre></div><h3 id=executing-tests>Executing Tests<a hidden class=anchor aria-hidden=true href=#executing-tests>#</a></h3><p>Once you have the above files ready in your project, it is very simple to run the tests. You can use a lot of command line options as per your need. These are described in detail <a href=https://behave.readthedocs.io/en/latest/behave.html#command-line-arguments>here</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ behave
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>.
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>.
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#ae81ff>1</span> feature passed, <span style=color:#ae81ff>0</span> failed, <span style=color:#ae81ff>0</span> skipped
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#ae81ff>1</span> scenario passed, <span style=color:#ae81ff>0</span> failed, <span style=color:#ae81ff>0</span> skipped
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#ae81ff>6</span> steps passed, <span style=color:#ae81ff>0</span> failed, <span style=color:#ae81ff>0</span> skipped, <span style=color:#ae81ff>0</span> undefined
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>Took 0m0.051s
</span></span></code></pre></div><p>To generate test reports in the junit format use the <code>--junit</code> command-line option. The so generated reports can then be used by any existing junit visualization frameworks you have, to create visualizations.</p><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>Apart from the obvious benefits of BDD, this workflow ensures issues are caught early and the deployments are error free. A side benefit of deploying it via a CI/CD pipeline is that it also syntax checks the actual VCL snippets before they make it to the live service. Since Fastly&rsquo;s vcl implementation is quite different from open source Varnish - it is near impossible to syntax check quickly using a varnish container.</p><b>Note:</b>&nbsp;
Code mentioned above is
<a aria-label="link to https://github.com/abiydv/fastly-bdd-example" target=_blank href=https://github.com/abiydv/fastly-bdd-example>here&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg><h2>References (2)</h2><ol class=slimlist-ol><li class=slimlist-ol><a aria-label="link to https://behave.readthedocs.io/en/latest/behave.html" target=_blank href=https://behave.readthedocs.io/en/latest/behave.html>Behave&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li class=slimlist-ol><a aria-label="link to https://docs.fastly.com/en/guides/about-vcl-snippets" target=_blank href=https://docs.fastly.com/en/guides/about-vcl-snippets>About Vcl Snippets&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ol><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>BDD or Behavior-driven development is an agile software development technique that encourages collaboration between developers, QA and non-technical or business participants in a software project&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><hr><div class=align-center><div class=slimlist-entry><h2>Tags</h2></div><ul class=post-tags><div class=slimlist-entry><li class=post-tags><a href=https://abiydv.github.io/tags/fastly/>fastly</a></li><li class=post-tags><a href=https://abiydv.github.io/tags/bdd/>bdd</a></li><li class=post-tags><a href=https://abiydv.github.io/tags/python/>python</a></li><li class=post-tags><a href=https://abiydv.github.io/tags/behave/>behave</a></li></div></ul></div></footer><script src=https://utteranc.es/client.js repo=abiydv/abiydv.github.io issue-term=title label=Comment theme=github-light crossorigin=anonymous async></script><hr><div class=align-left><div class=slimlist-entry><h2>Related</h2></div><ul class=slimlist><li class=slimlist><div class=slimlist-entry><h3 class=slimlist-entry-title><a aria-label="post link to Fastly Meta Service" href=https://abiydv.github.io/posts/fastly-meta-service/>Fastly Meta Service</a></h3><div class=slimlist-meta>10.11.20 / Posts / 3 min</div></div></li><li class=slimlist><div class=slimlist-entry><h3 class=slimlist-entry-title><a aria-label="post link to Github Actions for Python" href=https://abiydv.github.io/posts/python-github-actions/>Github Actions for Python</a></h3><div class=slimlist-meta>12.9.20 / Posts / 3 min</div></div></li><li class=slimlist><div class=slimlist-entry><h3 class=slimlist-entry-title><a aria-label="post link to Service Control Policies and BDD" href=https://abiydv.github.io/posts/aws-scp-test-bdd/>Service Control Policies and BDD</a></h3><div class=slimlist-meta>28.6.24 / Posts / 7 min</div></div></li></ul></div></article></main><footer class=footer><span>&copy; 2019-2025 <a href=https://abiydv.github.io/>@abiydv</a> / </span><span>Published 4.4.25 /
</span><span>Thanks <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a>, <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>