<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>AWS CloudTrail | @abiydv</title>
<meta name=keywords content><meta name=description content="Trails No IAM roles needed for cross-account delivery. #todo What principal does it show if you enable data events on the log delivery bucket?
Lake Ingest events into an event data source, and run sql queries on this data source.
Data can be collected from AWS (like CloudTrail events), custom application or 3rd parties (like okta system log)
Pricing is based on data ingestion, analysis and retention. It can retain data up to a maximum of 10 years."><meta name=author content><link rel=canonical href=https://abiydv.github.io/notes/aws/cloudtrail/><link crossorigin=anonymous href=/assets/css/stylesheet.c5edd088d0c984c192170cfbab7d2de030010ee0b7d771bd6bca049dd2332874.css integrity="sha256-xe3QiNDJhMGSFwz7q30t4DABDuC313G9a8oEndIzKHQ=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://abiydv.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://abiydv.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://abiydv.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://abiydv.github.io/apple-touch-icon.png><link rel=mask-icon href=https://abiydv.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://abiydv.github.io/notes/aws/cloudtrail/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="AWS CloudTrail"><meta property="og:description" content="Trails No IAM roles needed for cross-account delivery. #todo What principal does it show if you enable data events on the log delivery bucket?
Lake Ingest events into an event data source, and run sql queries on this data source.
Data can be collected from AWS (like CloudTrail events), custom application or 3rd parties (like okta system log)
Pricing is based on data ingestion, analysis and retention. It can retain data up to a maximum of 10 years."><meta property="og:type" content="article"><meta property="og:url" content="https://abiydv.github.io/notes/aws/cloudtrail/"><meta property="article:section" content="notes"><meta property="article:published_time" content="2024-02-15T00:00:00+00:00"><meta property="article:modified_time" content="2025-04-04T12:48:24+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="AWS CloudTrail"><meta name=twitter:description content="Trails No IAM roles needed for cross-account delivery. #todo What principal does it show if you enable data events on the log delivery bucket?
Lake Ingest events into an event data source, and run sql queries on this data source.
Data can be collected from AWS (like CloudTrail events), custom application or 3rd parties (like okta system log)
Pricing is based on data ingestion, analysis and retention. It can retain data up to a maximum of 10 years."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Notes","item":"https://abiydv.github.io/notes/"},{"@type":"ListItem","position":2,"name":"AWS","item":"https://abiydv.github.io/notes/aws/"},{"@type":"ListItem","position":3,"name":"AWS CloudTrail","item":"https://abiydv.github.io/notes/aws/cloudtrail/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"AWS CloudTrail","name":"AWS CloudTrail","description":"Trails No IAM roles needed for cross-account delivery. #todo What principal does it show if you enable data events on the log delivery bucket?\nLake Ingest events into an event data source, and run sql queries on this data source.\nData can be collected from AWS (like CloudTrail events), custom application or 3rd parties (like okta system log)\nPricing is based on data ingestion, analysis and retention. It can retain data up to a maximum of 10 years.","keywords":[],"articleBody":"Trails No IAM roles needed for cross-account delivery. #todo What principal does it show if you enable data events on the log delivery bucket?\nLake Ingest events into an event data source, and run sql queries on this data source.\nData can be collected from AWS (like CloudTrail events), custom application or 3rd parties (like okta system log)\nPricing is based on data ingestion, analysis and retention. It can retain data up to a maximum of 10 years.\nQuery Run a SQL like query against the events recorded in the CloudTrail lake. It does not support some query types.\nExamples Find all actions taken by user across accounts and regions\nSELECT eventID, eventName, eventSource, eventTime, userIdentity.arn AS user FROM \u003ccloudtrail-lake\u003e WHERE userIdentity.arn LIKE '%username%' AND eventTime \u003e '2023-11-11 00:00:00' AND eventTime \u003c '2023-11-11 16:30:00' SELECT eventTime, eventName, eventSource, awsRegion, resources, userIdentity.arn AS user, errorCode, errorMessage, eventID FROM \u003ccloudtrail-lake\u003e WHERE userIdentity.arn = 'arn:aws:sts::000123456789:assumed-role/some-role' AND NOT readOnly AND eventTime \u003e '2023-11-11 11:00:00' AND errorCode IS NOT NULL ORDER BY eventTime DESC Find out which accounts are generating most events, and what the most frequent events are\nSELECT recipientAccountId, eventName, COUNT(*) AS eventCount FROM \u003ccloudtrail-lake-id\u003e WHERE eventTime \u003e '2024-07-01 00:00:00' AND eventTime \u003c '2024-07-10 00:00:00' GROUP BY recipientAccountId, eventName ORDER BY eventCount DESC ","wordCount":"210","inLanguage":"en","datePublished":"2024-02-15T00:00:00Z","dateModified":"2025-04-04T12:48:24+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://abiydv.github.io/notes/aws/cloudtrail/"},"publisher":{"@type":"Organization","name":"@abiydv","logo":{"@type":"ImageObject","url":"https://abiydv.github.io/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://abiydv.github.io/ accesskey=h title="@abiydv (Alt + H)">@abiydv</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://abiydv.github.io/ title=Home><span>Home</span></a></li><li><a href=https://abiydv.github.io/about/ title=About><span>About</span></a></li><li><a href=https://abiydv.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://abiydv.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://abiydv.github.io/notes/ title=Notes><span>Notes</span></a></li><li><a href=https://abiydv.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://abiydv.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://abiydv.github.io/notes/>Notes</a>&nbsp;»&nbsp;<a href=https://abiydv.github.io/notes/aws/>AWS</a></div><h1 class=post-title>AWS CloudTrail<sup>&nbsp;<span class="entry-stage sandbox">&nbsp;sandbox&nbsp;</span></sup></h1><div class=post-meta><s>15.2.24</s>&nbsp;4.4.25 / Notes / 1 min</div></header><div class=post-content><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#trails aria-label=Trails>Trails</a></li><li><a href=#lake aria-label=Lake>Lake</a><ul><li><a href=#query aria-label=Query>Query</a><ul><li><a href=#examples aria-label=Examples>Examples</a></li></ul></li></ul></li></ul></div></details></div></div><div class=post-content><h1 id=trails>Trails<a hidden class=anchor aria-hidden=true href=#trails>#</a></h1><p>No IAM roles needed for cross-account delivery.
#todo What principal does it show if you enable data events on the log delivery bucket?</p><h1 id=lake>Lake<a hidden class=anchor aria-hidden=true href=#lake>#</a></h1><p>Ingest events into an event data source, and run sql queries on this data source.</p><p>Data can be collected from AWS (like CloudTrail events), custom application or 3rd parties (like okta system log)</p><p>Pricing is based on data ingestion, analysis and retention. It can retain data up to a maximum of 10 years.</p><h2 id=query>Query<a hidden class=anchor aria-hidden=true href=#query>#</a></h2><p>Run a SQL <em>like</em> query against the events recorded in the CloudTrail lake. It does not support some query types.</p><h3 id=examples>Examples<a hidden class=anchor aria-hidden=true href=#examples>#</a></h3><p>Find all actions taken by user across accounts and regions</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> eventID, eventName, eventSource, eventTime, userIdentity.arn <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>user</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> <span style=color:#f92672>&lt;</span>cloudtrail<span style=color:#f92672>-</span>lake<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> userIdentity.arn <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#39;%username%&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>AND</span> eventTime <span style=color:#f92672>&gt;</span> <span style=color:#e6db74>&#39;2023-11-11 00:00:00&#39;</span> <span style=color:#66d9ef>AND</span> eventTime <span style=color:#f92672>&lt;</span> <span style=color:#e6db74>&#39;2023-11-11 16:30:00&#39;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> eventTime, eventName, eventSource, awsRegion, resources, userIdentity.arn <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>user</span>, errorCode, errorMessage, eventID
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> <span style=color:#f92672>&lt;</span>cloudtrail<span style=color:#f92672>-</span>lake<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> userIdentity.arn <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;arn:aws:sts::000123456789:assumed-role/some-role&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>AND</span> <span style=color:#66d9ef>NOT</span> readOnly
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>AND</span> eventTime <span style=color:#f92672>&gt;</span> <span style=color:#e6db74>&#39;2023-11-11 11:00:00&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>AND</span> errorCode <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> eventTime <span style=color:#66d9ef>DESC</span>
</span></span></code></pre></div><p>Find out which accounts are generating most events, and what the most frequent events are</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> recipientAccountId, eventName, <span style=color:#66d9ef>COUNT</span>(<span style=color:#f92672>*</span>) <span style=color:#66d9ef>AS</span> eventCount
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> <span style=color:#f92672>&lt;</span>cloudtrail<span style=color:#f92672>-</span>lake<span style=color:#f92672>-</span>id<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> eventTime <span style=color:#f92672>&gt;</span> <span style=color:#e6db74>&#39;2024-07-01 00:00:00&#39;</span> <span style=color:#66d9ef>AND</span> eventTime <span style=color:#f92672>&lt;</span> <span style=color:#e6db74>&#39;2024-07-10 00:00:00&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> recipientAccountId, eventName
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> eventCount <span style=color:#66d9ef>DESC</span>
</span></span></code></pre></div></div><footer class=post-footer><hr><div class=align-center><div class=slimlist-entry><h2>Topics</h2></div><ul class=post-tags><div class=slimlist-entry><li class=post-tags><a href=https://abiydv.github.io/topics/aws/>aws</a></li><li class=post-tags><a href=https://abiydv.github.io/topics/stage-sandbox/>stage/sandbox</a></li><li class=post-tags><a href=https://abiydv.github.io/topics/audit/>audit</a></li><li class=post-tags><a href=https://abiydv.github.io/topics/governance/>governance</a></li><li class=post-tags><a href=https://abiydv.github.io/topics/security/>security</a></li></div></ul></div></footer><script src=https://utteranc.es/client.js repo=abiydv/abiydv.github.io issue-term=title label=Comment theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2019-2025 <a href=https://abiydv.github.io/>@abiydv</a> / </span><span>Published 4.4.25 /
</span><span>Thanks <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a>, <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>