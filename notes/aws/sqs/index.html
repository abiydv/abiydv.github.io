<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>AWS Simple Queue Service (SQS) | @abiydv</title>
<meta name=keywords content><meta name=description content="Scope Region
Features Apps PULL messages from a queue, process it and DELETE it. If the message is not deleted by a consumer, it is returned back to the queue after visibility timeout expires.
FIFO preserves order and ensure once only delivery. Also deduplication. Visibility timeout Retention period - max 14 days, by default 4 days. Delivery delay Redrive allow policy Redrive Move messages from DLQ to the main queue for re-preocessing."><meta name=author content><link rel=canonical href=https://abiydv.github.io/notes/aws/sqs/><link crossorigin=anonymous href=/assets/css/stylesheet.c5edd088d0c984c192170cfbab7d2de030010ee0b7d771bd6bca049dd2332874.css integrity="sha256-xe3QiNDJhMGSFwz7q30t4DABDuC313G9a8oEndIzKHQ=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://abiydv.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://abiydv.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://abiydv.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://abiydv.github.io/apple-touch-icon.png><link rel=mask-icon href=https://abiydv.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://abiydv.github.io/notes/aws/sqs/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="AWS Simple Queue Service (SQS)"><meta property="og:description" content="Scope Region
Features Apps PULL messages from a queue, process it and DELETE it. If the message is not deleted by a consumer, it is returned back to the queue after visibility timeout expires.
FIFO preserves order and ensure once only delivery. Also deduplication. Visibility timeout Retention period - max 14 days, by default 4 days. Delivery delay Redrive allow policy Redrive Move messages from DLQ to the main queue for re-preocessing."><meta property="og:type" content="article"><meta property="og:url" content="https://abiydv.github.io/notes/aws/sqs/"><meta property="article:section" content="notes"><meta property="article:published_time" content="2024-02-13T00:00:00+00:00"><meta property="article:modified_time" content="2024-06-28T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="AWS Simple Queue Service (SQS)"><meta name=twitter:description content="Scope Region
Features Apps PULL messages from a queue, process it and DELETE it. If the message is not deleted by a consumer, it is returned back to the queue after visibility timeout expires.
FIFO preserves order and ensure once only delivery. Also deduplication. Visibility timeout Retention period - max 14 days, by default 4 days. Delivery delay Redrive allow policy Redrive Move messages from DLQ to the main queue for re-preocessing."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Notes","item":"https://abiydv.github.io/notes/"},{"@type":"ListItem","position":2,"name":"AWS","item":"https://abiydv.github.io/notes/aws/"},{"@type":"ListItem","position":3,"name":"AWS Simple Queue Service (SQS)","item":"https://abiydv.github.io/notes/aws/sqs/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"AWS Simple Queue Service (SQS)","name":"AWS Simple Queue Service (SQS)","description":"Scope Region\nFeatures Apps PULL messages from a queue, process it and DELETE it. If the message is not deleted by a consumer, it is returned back to the queue after visibility timeout expires.\nFIFO preserves order and ensure once only delivery. Also deduplication. Visibility timeout Retention period - max 14 days, by default 4 days. Delivery delay Redrive allow policy Redrive Move messages from DLQ to the main queue for re-preocessing.","keywords":[],"articleBody":"Scope Region\nFeatures Apps PULL messages from a queue, process it and DELETE it. If the message is not deleted by a consumer, it is returned back to the queue after visibility timeout expires.\nFIFO preserves order and ensure once only delivery. Also deduplication. Visibility timeout Retention period - max 14 days, by default 4 days. Delivery delay Redrive allow policy Redrive Move messages from DLQ to the main queue for re-preocessing. Low value of maxReceiveCount can move messages to dead letter queue before any processing occurs in the main queue. Set it high to allow for retries in the main queue before a message is moved to the DLQ. Visibility Timeout Ideally, set the visibility timeout to roughly the same time as it takes a consumer to process and delete the message.\nShort Polling vs Long Polling In Short polling, SQS polls some of its servers to fech messages. Returns found messages, or empty if no message where found on the polled servers. On the next invocation, it fetches messages from other servers, finds the missed messages and sends it across. Eventually all messages get delivered, but empty responses or false empty responses are sent frequently.\nWaitTimeSeconds=0 specified for ReceiveMessage call or ReceiveMessageWaitTimeSeconds=0 queue property triggers short polling.\nIn Long polling, SQS collects messages from all servers before sending the response back. In this case, very rarely is the response empty or false empty. This also reduces overall cost of using SQS queues.\nWaitTimeSeconds\u003e0 specified for ReceiveMessage call or ReceiveMessageWaitTimeSeconds\u003e0 queue property triggers long polling. Max long polling time is 20 seconds.\nWaitTimeSeconds for ReceiveMessage is honoured (if specified) over queue property.\nAuto-scaling .. based on SQS message queue depth. CloudWatch metric does not handle auto scaling at the extremes quite as well - too few messages or too many messages.\nIn this case, a custom metric can be created like backlog per resource which is just message in the queue/current resources. This can be done by a cron based lambda executing every 60s. This custom metric can then be used for a more accurate auto-scaling EC2 or ECS.\nBackend Architecture This blog post from AWS provides some insights into SQS backend.\nIt consists of several micro-services, 2 of the important ones being front-end, and storage-backend.\nPre 2024 frontend service accepts API calls, handles authorization, and forwards the request to the storage-backend service.\nThe system consists of multiple clusters. Each cluster has multiple hosts and handles multiple customer queues. A customer queue can also be assigned to multiple clusters.\nSo, frontend system’s hosts connect to multiple hosts of the storage backend service. Using connection pools helps reuse some of these connections, however, given the scale of messages being transferred (100 mil/sec at peak times) this can hit hardware limits of how many connections can be open at a time.\nPost 2024 New frame1 transfer protocol between these 2 service deployed. It uses multiplexing, and can handle multiple requests/responses over a single connection. Reduced the load on the system, and it can now handle 20% more requests with the same specs. Performance times also imporved, reducing the time a message spends “in the backend” by almost 20%.\nQuestions How does auto-scaling based on message age in queue behave? References 1https://book.systemsapproach.org/direct/framing.html ","wordCount":"540","inLanguage":"en","datePublished":"2024-02-13T00:00:00Z","dateModified":"2024-06-28T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://abiydv.github.io/notes/aws/sqs/"},"publisher":{"@type":"Organization","name":"@abiydv","logo":{"@type":"ImageObject","url":"https://abiydv.github.io/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://abiydv.github.io/ accesskey=h title="@abiydv (Alt + H)">@abiydv</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://abiydv.github.io/ title=Home><span>Home</span></a></li><li><a href=https://abiydv.github.io/about/ title=About><span>About</span></a></li><li><a href=https://abiydv.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://abiydv.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://abiydv.github.io/notes/ title=Notes><span>Notes</span></a></li><li><a href=https://abiydv.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://abiydv.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://abiydv.github.io/notes/>Notes</a>&nbsp;»&nbsp;<a href=https://abiydv.github.io/notes/aws/>AWS</a></div><h1 class=post-title>AWS Simple Queue Service (SQS)<sup>&nbsp;<span class="entry-stage sandbox">&nbsp;sandbox&nbsp;</span></sup></h1><div class=post-meta><s>13.2.24</s>&nbsp;28.6.24 / Notes / 3 min</div></header><div class=post-content><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#scope aria-label=Scope>Scope</a></li><li><a href=#features aria-label=Features>Features</a><ul><li><a href=#redrive aria-label=Redrive>Redrive</a></li><li><a href=#visibility-timeout aria-label="Visibility Timeout">Visibility Timeout</a></li><li><a href=#short-polling-vs-long-polling aria-label="Short Polling vs Long Polling">Short Polling vs Long Polling</a></li><li><a href=#auto-scaling aria-label=Auto-scaling>Auto-scaling</a></li></ul></li><li><a href=#backend-architecture aria-label="Backend Architecture">Backend Architecture</a><ul><li><a href=#pre-2024 aria-label="Pre 2024">Pre 2024</a></li><li><a href=#post-2024 aria-label="Post 2024">Post 2024</a></li></ul></li><li><a href=#questions aria-label=Questions>Questions</a></li><li><a href=#references aria-label=References>References</a></li></ul></div></details></div></div><div class=post-content><h1 id=scope>Scope<a hidden class=anchor aria-hidden=true href=#scope>#</a></h1><p>Region</p><h1 id=features>Features<a hidden class=anchor aria-hidden=true href=#features>#</a></h1><p>Apps <em>PULL</em> messages from a queue, process it and <em>DELETE</em> it. If the message is not deleted by a consumer, it is returned back to the queue after visibility timeout expires.</p><ul><li>FIFO preserves order and ensure once only delivery. Also deduplication.</li><li>Visibility timeout</li><li>Retention period - max 14 days, by default 4 days.</li><li>Delivery delay</li><li>Redrive allow policy</li></ul><h2 id=redrive>Redrive<a hidden class=anchor aria-hidden=true href=#redrive>#</a></h2><ul><li>Move messages from DLQ to the main queue for re-preocessing.</li><li>Low value of <code>maxReceiveCount</code> can move messages to dead letter queue before any processing occurs in the main queue.</li><li>Set it high to allow for retries in the main queue before a message is moved to the DLQ.</li></ul><h2 id=visibility-timeout>Visibility Timeout<a hidden class=anchor aria-hidden=true href=#visibility-timeout>#</a></h2><p>Ideally, set the visibility timeout to roughly the same time as it takes a consumer to process and delete the message.</p><p><img loading=lazy src=https://docs.aws.amazon.com/images/AWSSimpleQueueService/latest/SQSDeveloperGuide/images/sqs-visibility-timeout-diagram.png alt=visibility-timeout></p><h2 id=short-polling-vs-long-polling>Short Polling vs Long Polling<a hidden class=anchor aria-hidden=true href=#short-polling-vs-long-polling>#</a></h2><p>In Short polling, SQS polls some of its servers to fech messages. Returns found messages, or empty if no message where found on the polled servers. On the next invocation, it fetches messages from other servers, finds the missed messages and sends it across. Eventually all messages get delivered, but empty responses or false empty responses are sent frequently.</p><p><code>WaitTimeSeconds=0</code> specified for <code>ReceiveMessage</code> call or <code>ReceiveMessageWaitTimeSeconds=0</code> queue property triggers short polling.</p><p>In Long polling, SQS collects messages from all servers before sending the response back. In this case, very rarely is the response empty or false empty. This also reduces overall cost of using SQS queues.</p><p><code>WaitTimeSeconds>0</code> specified for <code>ReceiveMessage</code> call or <code>ReceiveMessageWaitTimeSeconds>0</code> queue property triggers long polling.
Max long polling time is 20 seconds.</p><p><code>WaitTimeSeconds</code> for <code>ReceiveMessage</code> is honoured (if specified) over queue property.</p><h2 id=auto-scaling>Auto-scaling<a hidden class=anchor aria-hidden=true href=#auto-scaling>#</a></h2><p>.. based on SQS message queue depth. CloudWatch metric does not handle auto scaling at the extremes quite as well - too few messages or too many messages.</p><p>In this case, a custom metric can be created like backlog per resource which is just message in the queue/current resources. This can be done by a cron based lambda executing every 60s. This custom metric can then be used for a more accurate auto-scaling EC2 or ECS.</p><h1 id=backend-architecture>Backend Architecture<a hidden class=anchor aria-hidden=true href=#backend-architecture>#</a></h1><p>This <a href=https://aws.amazon.com/blogs/aws/optimizing-amazon-simple-queue-service-sqs-for-speed-and-scale/>blog post</a> from AWS provides some insights into SQS backend.</p><p>It consists of several micro-services, 2 of the important ones being front-end, and storage-backend.</p><p><img loading=lazy src=https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/03/25/sqs_fleets_3.png alt=img></p><h2 id=pre-2024>Pre 2024<a hidden class=anchor aria-hidden=true href=#pre-2024>#</a></h2><p>frontend service accepts API calls, handles authorization, and forwards the request to the storage-backend service.</p><p>The system consists of multiple clusters. Each cluster has multiple hosts and handles multiple customer queues. A customer queue can also be assigned to multiple clusters.</p><p>So, frontend system&rsquo;s hosts connect to multiple hosts of the storage backend service. Using connection pools helps reuse some of these connections, however, given the scale of messages being transferred (100 mil/sec at peak times) this can hit hardware limits of how many connections can be open at a time.</p><h2 id=post-2024>Post 2024<a hidden class=anchor aria-hidden=true href=#post-2024>#</a></h2><p>New frame1 transfer protocol between these 2 service deployed. It uses multiplexing, and can handle multiple requests/responses over a single connection. Reduced the load on the system, and it can now handle 20% more requests with the same specs. Performance times also imporved, reducing the time a message spends &ldquo;in the backend&rdquo; by almost 20%.</p><h1 id=questions>Questions<a hidden class=anchor aria-hidden=true href=#questions>#</a></h1><ol><li>How does auto-scaling based on message age in queue behave?</li></ol><h1 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h1><ul><li>1<a href=https://book.systemsapproach.org/direct/framing.html>https://book.systemsapproach.org/direct/framing.html</a></li></ul></div><footer class=post-footer><hr><div class=align-center><div class=slimlist-entry><h2>Topics</h2></div><ul class=post-tags><div class=slimlist-entry><li class=post-tags><a href=https://abiydv.github.io/topics/aws/>aws</a></li><li class=post-tags><a href=https://abiydv.github.io/topics/stage-sandbox/>stage/sandbox</a></li><li class=post-tags><a href=https://abiydv.github.io/topics/events/>events</a></li><li class=post-tags><a href=https://abiydv.github.io/topics/integrations/>integrations</a></li><li class=post-tags><a href=https://abiydv.github.io/topics/messaging/>messaging</a></li></div></ul></div></footer><script src=https://utteranc.es/client.js repo=abiydv/abiydv.github.io issue-term=title label=Comment theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2019-2025 <a href=https://abiydv.github.io/>@abiydv</a> / </span><span>Published 4.4.25 /
</span><span>Thanks <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a>, <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>